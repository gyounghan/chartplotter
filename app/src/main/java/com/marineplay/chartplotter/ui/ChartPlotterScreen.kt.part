                
                // ViewModelÏóêÏÑú ÏÉÅÌÉú Í∞ÄÏ†∏Ïò§Í∏∞
                val pointUiState = viewModel.pointUiState
                val mapUiState = viewModel.mapUiState
                val gpsUiState = viewModel.gpsUiState
                val trackUiState = viewModel.trackUiState
                val dialogUiState = viewModel.dialogUiState
                
                // UI Ï§å Î≤ÑÌäº ÏÉÅÌÉú Í¥ÄÎ¶¨
                var isZoomInPressed by remember { mutableStateOf(false) }
                var isZoomOutPressed by remember { mutableStateOf(false) }

                // üöÄ UI Ï§å Ïù∏ Î≤ÑÌäº Î°±ÌÅ¥Î¶≠ Î∞òÎ≥µ ÌôïÎåÄ (Í∞ÄÏÜçÎèÑ Ìö®Í≥º)
                LaunchedEffect(isZoomInPressed) {
                    if (isZoomInPressed) {
                        var iteration = 0
                        while (isZoomInPressed) {
                            mapLibreMap?.let { map ->
                                val currentZoom = map.cameraPosition.zoom
                                val newZoom = (currentZoom + 0.1).coerceAtMost(20.0)
                                
                                // Ïª§ÏÑúÍ∞Ä ÏûàÏúºÎ©¥ Ïª§ÏÑú ÏúÑÏπòÎ•º Ï§ëÏïôÏúºÎ°ú ÎßûÏ∂îÍ≥† Ï§å Ïù∏
                                if (mapUiState.showCursor && mapUiState.cursorLatLng != null) {
                                    val cursorLatLngValue = mapUiState.cursorLatLng!!
                                    
                                    // Ïª§ÏÑú ÏúÑÏπòÎ•º ÏßÄÎèÑ Ï§ëÏïôÏúºÎ°ú Ï¶âÏãú Ïù¥ÎèôÌïòÍ≥† Ï§å Ïù∏ (Ïï†ÎãàÎ©îÏù¥ÏÖò ÏóÜÏù¥)
                                    val cameraUpdate = org.maplibre.android.camera.CameraUpdateFactory.newCameraPosition(
                                        org.maplibre.android.camera.CameraPosition.Builder()
                                            .target(cursorLatLngValue)
                                            .zoom(newZoom)
                                            .build()
                                    )
                                    map.moveCamera(cameraUpdate) // animateCamera ÎåÄÏã† moveCamera ÏÇ¨Ïö© (Ï¶âÏãú Ïù¥Îèô)
                                    
                                    // Ïª§ÏÑú ÌôîÎ©¥ ÏúÑÏπòÎ•º Ï§ëÏïôÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                                    val centerScreenPoint = map.projection.toScreenLocation(cursorLatLngValue)
                                    viewModel.updateCursorScreenPosition(centerScreenPoint)
                                    
                                    Log.d("[MainActivity]", "Ï§å Ïù∏: Ïª§ÏÑú ÏúÑÏπò(${cursorLatLngValue.latitude}, ${cursorLatLngValue.longitude})Î•º Ï§ëÏïôÏúºÎ°ú ÎßûÏ∂îÍ≥† Ï§å $currentZoom -> $newZoom")
                                } else {
                                    // Ïª§ÏÑúÍ∞Ä ÏóÜÏúºÎ©¥ ÏùºÎ∞ò Ï§å Ïù∏
                                    val cameraUpdate = org.maplibre.android.camera.CameraUpdateFactory.zoomTo(newZoom)
                                    map.animateCamera(cameraUpdate, 300)
                                }
                                Log.d("[MainActivity]", "Ï§å Ïù∏: $currentZoom -> $newZoom")
                            }
                            
                            // Í∞ÄÏÜçÎèÑ Ìö®Í≥º: Ï≤òÏùåÏóêÎäî ÎäêÎ¶¨Í≤å(500ms), Ï†êÏ†ê Îπ®ÎùºÏ†∏ÏÑú ÏµúÏÜå 50msÍπåÏßÄ
                            val delayTime = (100L / (1.0 + iteration * 0.15)).toLong().coerceAtLeast(15L)
                            delay(delayTime)
                            iteration++
                        }
                    }
                }

                // üöÄ UI Ï§å ÏïÑÏõÉ Î≤ÑÌäº Î°±ÌÅ¥Î¶≠ Î∞òÎ≥µ Ï∂ïÏÜå (Í∞ÄÏÜçÎèÑ Ìö®Í≥º)
                LaunchedEffect(isZoomOutPressed) {
                    if (isZoomOutPressed) {
                        var iteration = 0
                        while (isZoomOutPressed) {
                            mapLibreMap?.let { map ->
                                val currentZoom = map.cameraPosition.zoom
                                val newZoom = (currentZoom - 0.1).coerceAtLeast(0.0)
                                
                                // Ïª§ÏÑúÍ∞Ä ÏûàÏúºÎ©¥ Ïª§ÏÑú ÏúÑÏπòÎ•º Ï§ëÏïôÏúºÎ°ú ÎßûÏ∂îÍ≥† Ï§å ÏïÑÏõÉ
                                if (mapUiState.showCursor && mapUiState.cursorLatLng != null) {
                                    val cursorLatLngValue = mapUiState.cursorLatLng!!
                                    
                                    // Ïª§ÏÑú ÏúÑÏπòÎ•º ÏßÄÎèÑ Ï§ëÏïôÏúºÎ°ú Ï¶âÏãú Ïù¥ÎèôÌïòÍ≥† Ï§å ÏïÑÏõÉ (Ïï†ÎãàÎ©îÏù¥ÏÖò ÏóÜÏù¥)
                                    val cameraUpdate = org.maplibre.android.camera.CameraUpdateFactory.newCameraPosition(
                                        org.maplibre.android.camera.CameraPosition.Builder()
                                            .target(cursorLatLngValue)
                                            .zoom(newZoom)
                                            .build()
                                    )
                                    map.moveCamera(cameraUpdate) // animateCamera ÎåÄÏã† moveCamera ÏÇ¨Ïö© (Ï¶âÏãú Ïù¥Îèô)
                                    
                                    // Ïª§ÏÑú ÌôîÎ©¥ ÏúÑÏπòÎ•º Ï§ëÏïôÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                                    val centerScreenPoint = map.projection.toScreenLocation(cursorLatLngValue)
                                    viewModel.updateCursorScreenPosition(centerScreenPoint)
                                    
                                    Log.d("[MainActivity]", "Ï§å ÏïÑÏõÉ: Ïª§ÏÑú ÏúÑÏπò(${cursorLatLngValue.latitude}, ${cursorLatLngValue.longitude})Î•º Ï§ëÏïôÏúºÎ°ú ÎßûÏ∂îÍ≥† Ï§å $currentZoom -> $newZoom")
                                } else {
                                    // Ïª§ÏÑúÍ∞Ä ÏóÜÏúºÎ©¥ ÏùºÎ∞ò Ï§å ÏïÑÏõÉ
                                    val cameraUpdate = org.maplibre.android.camera.CameraUpdateFactory.zoomTo(newZoom)
                                    map.animateCamera(cameraUpdate, 300)
                                }
                                Log.d("[MainActivity]", "Ï§å ÏïÑÏõÉ: $currentZoom -> $newZoom")
                            }
                            
                            // Í∞ÄÏÜçÎèÑ Ìö®Í≥º: Ï≤òÏùåÏóêÎäî ÎäêÎ¶¨Í≤å(500ms), Ï†êÏ†ê Îπ®ÎùºÏ†∏ÏÑú ÏµúÏÜå 50msÍπåÏßÄ
                            val delayTime = (100L / (1.0 + iteration * 0.15)).toLong().coerceAtLeast(15L)
                            delay(delayTime)
                            iteration++
                        }
                    }
                }

                // ÏßÄÎèÑ ÌëúÏãú Î™®Îìú Î≥ÄÍ≤Ω Ïãú ÌöåÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏
                LaunchedEffect(mapUiState.mapDisplayMode) {
                    updateMapRotation(viewModel)
                }

                // ÏΩîÏä§ÏóÖ Î™®ÎìúÏóêÏÑú Ìè¨Ïù∏Ìä∏ Î≥ÄÍ≤Ω Ïãú ÌöåÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏
                LaunchedEffect(mapUiState.coursePoint) {
                    if (mapUiState.mapDisplayMode == "ÏΩîÏä§ÏóÖ") {
                        updateMapRotation(viewModel)
                    }
                }
                // Ìè¨Ïù∏Ìä∏ Îì±Î°ù Îã§Ïù¥ÏñºÎ°úÍ∑∏ ÌëúÏãú
                if (dialogUiState.showDialog) {
                    PointRegistrationDialog(
                        centerCoordinates = pointUiState.centerCoordinates,
                        pointName = pointUiState.pointName,
                        onPointNameChange = { viewModel.updatePointName(it) },
                        selectedColor = pointUiState.selectedColor,
                        onColorChange = { viewModel.updateSelectedColor(it) },
                        selectedIconType = pointUiState.selectedIconType,
                        onIconTypeChange = { viewModel.updateSelectedIconType(it) },
                        getNextAvailablePointNumber = { getNextAvailablePointNumber() },
                        onRegister = { registerPoint(viewModel) },
                        onDismiss = { viewModel.updateShowDialog(false) }
                    )
                }

                // Ìè¨Ïù∏Ìä∏ Í¥ÄÎ¶¨ Îã§Ïù¥ÏñºÎ°úÍ∑∏ ÌëúÏãú
                if (dialogUiState.showPointManageDialog && pointUiState.selectedPoint != null) {
                    PointManageDialog(
                        point = pointUiState.selectedPoint!!,
                        onDelete = { deletePoint(pointUiState.selectedPoint!!, viewModel) },
                        onEdit = {
                            viewModel.updateShowPointManageDialog(false)
                            viewModel.updateShowEditDialog(true)
                        },
                        onDismiss = { viewModel.updateShowPointManageDialog(false) }
                    )
                }

                // Ìè¨Ïù∏Ìä∏ Ìé∏Ïßë Îã§Ïù¥ÏñºÎ°úÍ∑∏ ÌëúÏãú
                if (dialogUiState.showEditDialog && pointUiState.selectedPoint != null) {
                    PointEditDialog(
                        point = pointUiState.selectedPoint!!,
                        pointName = pointUiState.editPointName,
                        onPointNameChange = { viewModel.updateEditPointName(it) },
                        selectedColor = pointUiState.editSelectedColor,
                        onColorChange = { viewModel.updateEditSelectedColor(it) },
                        onSave = { updatePoint(pointUiState.selectedPoint!!, pointUiState.editPointName, pointUiState.editSelectedColor, viewModel) },
                        onDismiss = { viewModel.updateShowEditDialog(false) }
                    )
                }

                // Ìè¨Ïù∏Ìä∏ ÏÇ≠Ï†ú Î™©Î°ù Îã§Ïù¥ÏñºÎ°úÍ∑∏ ÌëúÏãú
                if (dialogUiState.showPointDeleteList) {
                    PointDeleteListDialog(
                        points = loadPointsFromLocal(),
                        onDeletePoint = { point -> deletePoint(point, viewModel) },
                        onDismiss = { viewModel.updateShowPointDeleteList(false) }
                    )
                }

                // Ìï≠Ï†Å ÏÑ§Ï†ï Îã§Ïù¥ÏñºÎ°úÍ∑∏
                if (dialogUiState.showTrackSettingsDialog) {
                    var intervalType by remember { mutableStateOf(trackManager.settings.intervalType) }
                    var timeInterval by remember { mutableStateOf(trackManager.settings.timeInterval.toString()) }
                    var distanceInterval by remember { mutableStateOf(trackManager.settings.distanceInterval.toString()) }
                    
                    AlertDialog(
                        onDismissRequest = { viewModel.updateShowTrackSettingsDialog(false) },
                        title = { Text("Ìï≠Ï†Å ÏÑ§Ï†ï") },
                        text = {
                            Column {
                                Text("Í∏∞Î°ù Í∞ÑÍ≤© ÏÑ§Ï†ï:", fontWeight = FontWeight.Bold)
                                Spacer(modifier = Modifier.height(8.dp))
                                
                                // ÏãúÍ∞Ñ Í∞ÑÍ≤© ÏÑ†ÌÉù
                                Row(verticalAlignment = Alignment.CenterVertically) {
                                    androidx.compose.material3.RadioButton(
                                        selected = intervalType == "time",
                                        onClick = { intervalType = "time" }
                                    )
                                    Text("ÏãúÍ∞Ñ Í∞ÑÍ≤©", modifier = Modifier.clickable { intervalType = "time" })
                                    Spacer(modifier = Modifier.width(8.dp))
                                    if (intervalType == "time") {
                                        TextField(
                                            value = timeInterval,
                                            onValueChange = { timeInterval = it },
                                            label = { Text("Î∞ÄÎ¶¨Ï¥à") },
                                            modifier = Modifier.width(120.dp)
                                        )
                                    }
                                }
                                
                                Spacer(modifier = Modifier.height(8.dp))
                                
                                // Í±∞Î¶¨ Í∞ÑÍ≤© ÏÑ†ÌÉù
                                Row(verticalAlignment = Alignment.CenterVertically) {
                                    androidx.compose.material3.RadioButton(
                                        selected = intervalType == "distance",
                                        onClick = { intervalType = "distance" }
                                    )
                                    Text("Í±∞Î¶¨ Í∞ÑÍ≤©", modifier = Modifier.clickable { intervalType = "distance" })
                                    Spacer(modifier = Modifier.width(8.dp))
                                    if (intervalType == "distance") {
                                        TextField(
                                            value = distanceInterval,
                                            onValueChange = { distanceInterval = it },
                                            label = { Text("ÎØ∏ÌÑ∞") },
                                            modifier = Modifier.width(120.dp)
                                        )
                                    }
                                }
                            }
                        },
                        confirmButton = {
                            TextButton(
                                onClick = {
                                    val settings = TrackSettings(
                                        intervalType = intervalType,
                                        timeInterval = if (intervalType == "time") timeInterval.toLongOrNull() ?: 5000L else trackManager.settings.timeInterval,
                                        distanceInterval = if (intervalType == "distance") distanceInterval.toDoubleOrNull() ?: 10.0 else trackManager.settings.distanceInterval
                                    )
                                    trackManager.saveSettings(settings)
                                    viewModel.updateShowTrackSettingsDialog(false)
                                }
                            ) {
                                Text("Ï†ÄÏû•")
                            }
                        },
                        dismissButton = {
                            TextButton(
                                onClick = { viewModel.updateShowTrackSettingsDialog(false) }
                            ) {
                                Text("Ï∑®ÏÜå")
                            }
                        }
                    )
                }
                
                // Ìï≠Ï†Å Î™©Î°ù Îã§Ïù¥ÏñºÎ°úÍ∑∏
                if (dialogUiState.showTrackListDialog) {
                    var newTrackName by remember { mutableStateOf("") }
                    var newTrackColor by remember { mutableStateOf(Color.Red) }
                    var showNewTrackDialog by remember { mutableStateOf(false) }
                    
                    AlertDialog(
                        onDismissRequest = { viewModel.updateShowTrackListDialog(false) },
                        title = { Text("Ìï≠Ï†Å Î™©Î°ù") },
                        text = {
                            Column {
                                // ÏÉà Ìï≠Ï†Å Ï∂îÍ∞Ä Î≤ÑÌäº
                                Button(
                                    onClick = { showNewTrackDialog = true },
                                    modifier = Modifier.fillMaxWidth()
                                ) {
                                    Text("ÏÉà Ìï≠Ï†Å Ï∂îÍ∞Ä")
                                }
                                
                                Spacer(modifier = Modifier.height(8.dp))
                                
                                // Ìï≠Ï†Å Î™©Î°ù
                                LazyColumn {
                                    items(trackManager.getTracks()) { track ->
                                        Card(
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 4.dp),
                                            colors = CardDefaults.cardColors(
                                                containerColor = if (track.isVisible) track.color.copy(alpha = 0.3f) else Color.Gray.copy(alpha = 0.2f)
                                            )
                                        ) {
                                            Column(modifier = Modifier.padding(8.dp)) {
                                                Row(
                                                    modifier = Modifier.fillMaxWidth(),
                                                    horizontalArrangement = Arrangement.SpaceBetween,
                                                    verticalAlignment = Alignment.CenterVertically
                                                ) {
                                                    Column {
                                                        Text(
                                                            text = track.name,
                                                            fontWeight = FontWeight.Bold,
                                                            color = Color.White
                                                        )
                                                        Text(
                                                            text = "Í∏∞Î°ù ${track.records.size}Í∞ú",
                                                            fontSize = 12.sp,
                                                            color = Color.White
                                                        )
                                                    }
                                                    
                                                    Row(
                                                        verticalAlignment = Alignment.CenterVertically,
                                                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                                                    ) {
                                                        // ÌëúÏãú/Ïà®ÍπÄ Ïä§ÏúÑÏπò
                                                        Switch(
                                                            checked = track.isVisible,
                                                            onCheckedChange = {
                                                                trackManager.setTrackVisibility(track.id, it)
                                                                updateTrackDisplay(viewModel)
                                                            }
                                                        )
                                                        
                                                        // Í∏∞Î°ù ÏãúÏûë Î≤ÑÌäº
                                                        if (!trackUiState.isRecordingTrack) {
                                                            TextButton(
                                                                onClick = {
                                                                    startTrackRecording(track, viewModel)
                                                                    viewModel.updateShowTrackListDialog(false)
                                                                }
                                                            ) {
                                                                Text("Í∏∞Î°ù", fontSize = 12.sp)
                                                            }
                                                        }
                                                        
                                                        // ÏÇ≠Ï†ú Î≤ÑÌäº
                                                        TextButton(
                                                            onClick = {
                                                                trackManager.deleteTrack(track.id)
                                                                updateTrackDisplay(viewModel)
                                                            }
                                                        ) {
                                                            Text("ÏÇ≠Ï†ú", fontSize = 12.sp, color = Color.Red)
                                                        }
                                                    }
                                                }
                                                
                                                // Ìï≠Ï†Å Í∏∞Î°ù Î™©Î°ù
                                                if (track.records.isNotEmpty()) {
                                                    Spacer(modifier = Modifier.height(4.dp))
                                                    track.records.forEach { record ->
                                                        Row(
                                                            modifier = Modifier
                                                                .fillMaxWidth()
                                                                .padding(vertical = 2.dp),
                                                            horizontalArrangement = Arrangement.SpaceBetween,
                                                            verticalAlignment = Alignment.CenterVertically
                                                        ) {
                                                            Text(
                                                                text = record.title,
                                                                fontSize = 11.sp,
                                                                color = Color.White
                                                            )
                                                            TextButton(
                                                                onClick = {
                                                                    // ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï≤òÎ¶¨
                                                                    viewModel.updateHighlightedTrackRecord(Pair(track.id, record.id))
                                                                    updateTrackDisplay(viewModel)
                                                                    viewModel.updateSelectedTrackForRecords(track)
                                                                    viewModel.updateShowTrackRecordListDialog(true)
                                                                }
                                                            ) {
                                                                Text("Î≥¥Í∏∞", fontSize = 10.sp)
                                                            }
                                                            TextButton(
                                                                onClick = {
                                                                    trackManager.deleteTrackRecord(track.id, record.id)
                                                                    updateTrackDisplay(viewModel)
                                                                }
                                                            ) {
                                                                Text("ÏÇ≠Ï†ú", fontSize = 10.sp, color = Color.Red)
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        confirmButton = {
                            TextButton(
                                onClick = { viewModel.updateShowTrackListDialog(false) }
                            ) {
                                Text("Îã´Í∏∞")
                            }
                        }
                    )
                    
                    // ÏÉà Ìï≠Ï†Å Ï∂îÍ∞Ä Îã§Ïù¥ÏñºÎ°úÍ∑∏
                    if (showNewTrackDialog) {
                        AlertDialog(
                            onDismissRequest = { showNewTrackDialog = false },
                            title = { Text("ÏÉà Ìï≠Ï†Å Ï∂îÍ∞Ä") },
                            text = {
                                Column {
                                    TextField(
                                        value = newTrackName,
                                        onValueChange = { newTrackName = it },
                                        label = { Text("Ìï≠Ï†Å Ïù¥Î¶Ñ") },
                                        modifier = Modifier.fillMaxWidth()
                                    )
                                    Spacer(modifier = Modifier.height(8.dp))
                                    Text("ÏÉâÏÉÅ ÏÑ†ÌÉù:")
                                    Row {
                                        listOf(Color.Red, Color.Blue, Color.Green, Color.Yellow, Color.Cyan, Color.Magenta).forEach { color ->
                                            Box(
                                                modifier = Modifier
                                                    .size(40.dp)
                                                    .background(color, CircleShape)
                                                    .clickable { newTrackColor = color }
                                                    .padding(4.dp)
                                            )
                                        }
                                    }
                                }
                            },
                            confirmButton = {
                                TextButton(
                                    onClick = {
                                        if (newTrackName.isNotBlank()) {
                                            trackManager.addTrack(newTrackName, newTrackColor)
                                            newTrackName = ""
                                            newTrackColor = Color.Red
                                            showNewTrackDialog = false
                                        }
                                    }
                                ) {
                                    Text("Ï∂îÍ∞Ä")
                                }
                            },
                            dismissButton = {
                                TextButton(
                                    onClick = { showNewTrackDialog = false }
                                ) {
                                    Text("Ï∑®ÏÜå")
                                }
                            }
                        )
                    }
                }
                
                // Ìï≠Ï†Å Í∏∞Î°ù Î™©Î°ù Îã§Ïù¥ÏñºÎ°úÍ∑∏
                if (dialogUiState.showTrackRecordListDialog && trackUiState.selectedTrackForRecords != null) {
                    AlertDialog(
                        onDismissRequest = { 
                            viewModel.updateShowTrackRecordListDialog(false)
                            viewModel.updateSelectedTrackForRecords(null)
                        },
                        title = { Text("${trackUiState.selectedTrackForRecords!!.name} - Ìï≠Ï†Å Í∏∞Î°ù") },
                        text = {
                            LazyColumn {
                                items(trackUiState.selectedTrackForRecords!!.records) { record ->
                                    val isHighlighted = trackUiState.highlightedTrackRecord != null && 
                                                       trackUiState.highlightedTrackRecord!!.first == trackUiState.selectedTrackForRecords!!.id && 
                                                       trackUiState.highlightedTrackRecord!!.second == record.id
                                    Card(
                                        modifier = Modifier
                                            .fillMaxWidth()
                                            .padding(vertical = 4.dp)
                                            .clickable {
                                                // ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï≤òÎ¶¨
                                                viewModel.updateHighlightedTrackRecord(Pair(trackUiState.selectedTrackForRecords!!.id, record.id))
                                                updateTrackDisplay(viewModel)
                                            },
                                        colors = CardDefaults.cardColors(
                                            containerColor = if (isHighlighted) {
                                                Color.Yellow.copy(alpha = 0.5f) // ÌïòÏù¥ÎùºÏù¥Ìä∏Îêú Í≤ΩÏö∞ ÎÖ∏ÎûÄÏÉâ Î∞∞Í≤Ω
                                            } else {
                                                trackUiState.selectedTrackForRecords!!.color.copy(alpha = 0.3f)
                                            }
                                        )
                                    ) {
                                        Column(modifier = Modifier.padding(8.dp)) {
                                            Text(
                                                text = record.title,
                                                fontWeight = FontWeight.Bold,
                                                color = Color.White
                                            )
                                            Text(
                                                text = "Ï†ê ${record.points.size}Í∞ú",
                                                fontSize = 12.sp,
                                                color = Color.White
                                            )
                                        }
                                    }
                                }
                            }
                        },
                        confirmButton = {
                            Row {
                                TextButton(
                                    onClick = { 
                                        // ÌïòÏù¥ÎùºÏù¥Ìä∏ Ìï¥Ï†ú
                                        viewModel.updateHighlightedTrackRecord(null)
                                        updateTrackDisplay(viewModel)
                                    }
                                ) {
                                    Text("ÌïòÏù¥ÎùºÏù¥Ìä∏ Ìï¥Ï†ú")
                                }
                                TextButton(
                                    onClick = { 
                                        viewModel.updateShowTrackRecordListDialog(false)
                                        viewModel.updateSelectedTrackForRecords(null)
                                    }
                                ) {
                                    Text("Îã´Í∏∞")
                                }
                            }
                        }
                    )
                }
                
                // Í≤ΩÏú†ÏßÄ Í¥ÄÎ¶¨ Îã§Ïù¥ÏñºÎ°úÍ∑∏
                if (dialogUiState.showWaypointDialog) {
                    AlertDialog(
                        onDismissRequest = { viewModel.updateShowWaypointDialog(false) },
                        title = { Text("Í≤ΩÏú†ÏßÄ Í¥ÄÎ¶¨") },
                        text = {
                            Column {
                                // Í≤ΩÏú†ÏßÄ Ï∂îÍ∞Ä Î≤ÑÌäº
                                Button(
                                    onClick = {
                                        viewModel.updateIsAddingWaypoint(true)
                                        viewModel.updateShowWaypointDialog(false) // Îã§Ïù¥ÏñºÎ°úÍ∑∏ Îã´Í∏∞
                                    },
                                    modifier = Modifier.fillMaxWidth()
                                ) {
                                    Text("Í≤ΩÏú†ÏßÄ Ï∂îÍ∞Ä")
                                }
                                
                                Spacer(modifier = Modifier.height(8.dp))
                                
                                // Í≤ΩÏú†ÏßÄ Î™©Î°ù
                                if (mapUiState.waypoints.isEmpty()) {
                                    Text(
                                        "Í≤ΩÏú†ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.",
                                        fontSize = 12.sp,
                                        color = Color.Gray,
                                        modifier = Modifier.padding(8.dp)
                                    )
                                } else {
                                    LazyColumn {
                                        items(mapUiState.waypoints.size) { index ->
                                            val waypoint = mapUiState.waypoints[index]
                                            Card(
                                                modifier = Modifier
                                                    .fillMaxWidth()
                                                    .padding(vertical = 4.dp),
                                                colors = CardDefaults.cardColors(
                                                    containerColor = waypoint.color.copy(alpha = 0.3f)
                                                )
                                            ) {
                                                Row(
                                                    modifier = Modifier
                                                        .fillMaxWidth()
                                                        .padding(8.dp),
                                                    horizontalArrangement = Arrangement.SpaceBetween,
                                                    verticalAlignment = Alignment.CenterVertically
                                                ) {
                                                    Column {
                                                        Text(
                                                            text = "${index + 1}. ${waypoint.name}",
                                                            fontWeight = FontWeight.Bold,
                                                            color = Color.White
                                                        )
                                                        Text(
                                                            text = "${waypoint.latitude}, ${waypoint.longitude}",
                                                            fontSize = 11.sp,
                                                            color = Color.White
                                                        )
                                                    }
                                                    
                                                    Row {
                                                        // ÏúÑÎ°ú Ïù¥Îèô
                                                        if (index > 0) {
                                                            TextButton(
                                                                onClick = {
                                                                    val updatedWaypoints = mapUiState.waypoints.toMutableList()
                                                                    val temp = updatedWaypoints[index]
                                                                    updatedWaypoints[index] = updatedWaypoints[index - 1]
                                                                    updatedWaypoints[index - 1] = temp
                                                                    viewModel.updateWaypoints(updatedWaypoints)
                                                                    // Í≤ΩÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                                                                    if (mapUiState.navigationPoint != null) {
                                                                        val currentLocation = locationManager?.getCurrentLocationObject()
                                                                        val map = mapLibreMap
                                                                        if (currentLocation != null && map != null) {
                                                                            val currentLatLng = LatLng(currentLocation.latitude, currentLocation.longitude)
                                                                            val waypointLatLngs = updatedWaypoints.map { LatLng(it.latitude, it.longitude) }
                                                                            val navigationLatLng = LatLng(mapUiState.navigationPoint!!.latitude, mapUiState.navigationPoint!!.longitude)
                                                                            PMTilesLoader.addNavigationRoute(map, currentLatLng, waypointLatLngs, navigationLatLng)
                                                                        }
                                                                    }
                                                                }
                                                            ) {
                                                                Text("‚Üë", fontSize = 12.sp)
                                                            }
                                                        }
                                                        
                                                        // ÏïÑÎûòÎ°ú Ïù¥Îèô
                                                        if (index < mapUiState.waypoints.size - 1) {
                                                            TextButton(
                                                                onClick = {
                                                                    val updatedWaypoints = mapUiState.waypoints.toMutableList()
                                                                    val temp = updatedWaypoints[index]
                                                                    updatedWaypoints[index] = updatedWaypoints[index + 1]
                                                                    updatedWaypoints[index + 1] = temp
                                                                    viewModel.updateWaypoints(updatedWaypoints)
                                                                    // Í≤ΩÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                                                                    if (mapUiState.navigationPoint != null) {
                                                                        val currentLocation = locationManager?.getCurrentLocationObject()
                                                                        val map = mapLibreMap
                                                                        if (currentLocation != null && map != null) {
                                                                            val currentLatLng = LatLng(currentLocation.latitude, currentLocation.longitude)
                                                                            val waypointLatLngs = updatedWaypoints.map { LatLng(it.latitude, it.longitude) }
                                                                            val navigationLatLng = LatLng(mapUiState.navigationPoint!!.latitude, mapUiState.navigationPoint!!.longitude)
                                                                            PMTilesLoader.addNavigationRoute(map, currentLatLng, waypointLatLngs, navigationLatLng)
                                                                        }
                                                                    }
                                                                }
                                                            ) {
                                                                Text("‚Üì", fontSize = 12.sp)
                                                            }
                                                        }
                                                        
                                                        // ÏÇ≠Ï†ú
                                                        TextButton(
                                                            onClick = {
                                                                val updatedWaypoints = mapUiState.waypoints.toMutableList()
                                                                updatedWaypoints.removeAt(index)
                                                                viewModel.updateWaypoints(updatedWaypoints)
                                                                // Í≤ΩÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                                                                if (mapUiState.navigationPoint != null) {
                                                                    val currentLocation = locationManager?.getCurrentLocationObject()
                                                                    val map = mapLibreMap
                                                                    if (currentLocation != null && map != null) {
                                                                        val currentLatLng = LatLng(currentLocation.latitude, currentLocation.longitude)
                                                                        val waypointLatLngs = updatedWaypoints.map { LatLng(it.latitude, it.longitude) }
                                                                        val navigationLatLng = LatLng(mapUiState.navigationPoint!!.latitude, mapUiState.navigationPoint!!.longitude)
                                                                        PMTilesLoader.addNavigationRoute(map, currentLatLng, waypointLatLngs, navigationLatLng)
                                                                    }
                                                                }
                                                            }
                                                        ) {
                                                            Text("ÏÇ≠Ï†ú", fontSize = 12.sp, color = Color.Red)
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        confirmButton = {
                            TextButton(
                                onClick = { viewModel.updateShowWaypointDialog(false) }
                            ) {
                                Text("Îã´Í∏∞")
                            }
                        }
                    )
                }
                
                // Ìè¨Ïù∏Ìä∏ ÏÑ†ÌÉù Îã§Ïù¥ÏñºÎ°úÍ∑∏ (ÏΩîÏä§ÏóÖÏö© Î∞è Í≤ΩÏú†ÏßÄ Ï∂îÍ∞ÄÏö©)
                if (dialogUiState.showPointSelectionDialog) {
                    AlertDialog(
                        onDismissRequest = { 
                            viewModel.updateShowPointSelectionDialog(false)
                        },
                        title = { Text("ÏΩîÏä§ÏóÖ Ìè¨Ïù∏Ìä∏ ÏÑ†ÌÉù") },
                        text = {
                            Column {
                                Text("ÏΩîÏä§ÏóÖÏúºÎ°ú ÏÇ¨Ïö©Ìï† Ìè¨Ïù∏Ìä∏Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî:")
                                Spacer(modifier = Modifier.height(8.dp))
                                
                                LazyColumn {
                                    items(loadPointsFromLocal()) { point ->
                                        Card(
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 4.dp)
                                                .clickable {
                                                    // Ìï≠Ìï¥ Î©îÎâ¥ÏóêÏÑú Ìò∏Ï∂úÎêú Í≤ΩÏö∞ Ìï≠Ìï¥ Ìè¨Ïù∏Ìä∏Î°ú ÏÑ§Ï†ï
                                                    if (mapUiState.currentMenu == "navigation") {
                                                        // Í∏∞Ï°¥ Ìï≠Ìï¥ ÏÑ†Í≥º ÎßàÏª§ Ï†úÍ±∞
                                                        mapLibreMap?.let { map ->
                                                            PMTilesLoader.removeNavigationLine(map)
                                                            PMTilesLoader.removeNavigationMarker(map)
                                                        }
                                                        
                                                        viewModel.updateNavigationPoint(point)
                                                        // Ìï≠Ìï¥ Í≤ΩÎ°ú Î∞è ÎßàÏª§ ÌëúÏãú
                                                        val currentLocation = locationManager?.getCurrentLocationObject()
                                                        val map = mapLibreMap
                                                        if (currentLocation != null && map != null) {
                                                            val currentLatLng = LatLng(currentLocation.latitude, currentLocation.longitude)
                                                            val waypointLatLngs = mapUiState.waypoints.map { LatLng(it.latitude, it.longitude) }
                                                            val navigationLatLng = LatLng(point.latitude, point.longitude)
                                                            PMTilesLoader.addNavigationRoute(map, currentLatLng, waypointLatLngs, navigationLatLng)
                                                            PMTilesLoader.addNavigationMarker(map, navigationLatLng, point.name)
                                                        }
                                                        
                                                        // ÏΩîÏä§ÏóÖ Î™®ÎìúÍ∞Ä ÏºúÏ†∏ ÏûàÎã§Î©¥ ÏÉàÎ°úÏö¥ Ìï≠Ìï¥ Î™©Ï†ÅÏßÄÎ°ú ÏΩîÏä§ÏóÖ Ï†ÅÏö©
                                                        if (mapUiState.mapDisplayMode == "ÏΩîÏä§ÏóÖ") {
                                                            viewModel.updateCoursePoint(point)
                                                            updateMapRotation(viewModel)
                                                            Log.d("[MainActivity]", "Ìï≠Ìï¥ Î™©Ï†ÅÏßÄ Î≥ÄÍ≤ΩÏúºÎ°ú ÏΩîÏä§ÏóÖ Ïû¨Ï†ÅÏö©: ${point.name}")
                                                        }
                                                    } else {
                                                        // ÏΩîÏä§ÏóÖ Î©îÎâ¥ÏóêÏÑú Ìò∏Ï∂úÎêú Í≤ΩÏö∞ ÏΩîÏä§ÏóÖ Ìè¨Ïù∏Ìä∏Î°ú ÏÑ§Ï†ï
                                                        viewModel.updateCoursePoint(point)
                                                        viewModel.updateMapDisplayMode("ÏΩîÏä§ÏóÖ")
                                                        updateMapRotation(viewModel)
                                                    }
                                                    viewModel.updateShowPointSelectionDialog(false)
                                                },
                                            colors = CardDefaults.cardColors(
                                                containerColor = if (mapUiState.coursePoint == point) Color.Yellow else Color.White
                                            )
                                        ) {
                                            Text(
                                                text = "${point.name} (${String.format("%.6f", point.latitude)}, ${String.format("%.6f", point.longitude)})",
                                                modifier = Modifier.padding(8.dp),
                                                color = if (mapUiState.coursePoint == point) Color.Black else Color.Black
                                            )
                                        }
                                    }
                                }
                            }
                        },
                        confirmButton = {
                            TextButton(
                                onClick = { 
                                    viewModel.updateShowPointSelectionDialog(false)
                                }
                            ) {
                                Text("Ï∑®ÏÜå")
                            }
                        }
                    )
                }





                Scaffold(
                    modifier = Modifier.fillMaxSize(),
                    floatingActionButtonPosition = FabPosition.End,
                    floatingActionButton = {
                        // Î©îÎâ¥Ï∞ΩÏù¥ Ïó¥Î†§ÏûàÏùÑ ÎïåÎäî ÌîåÎ°úÌåÖ Î≤ÑÌäº Ïà®ÍπÄ
                        if (!mapUiState.showMenu) {
                            // ÌòÑÏû¨ ÏúÑÏπò Î≤ÑÌäº (Ïö∞Ï∏° ÌïòÎã®)
                            FloatingActionButton(
                            onClick = {
                                locationManager?.startAutoTracking()
                                // ÌòÑÏû¨ ÏúÑÏπòÎ°ú Ïù¥ÎèôÌï† Îïå Ïª§ÏÑú Ïà®ÍπÄ
                                viewModel.updateShowCursor(false)
                                viewModel.updateCursorLatLng(null)
                                viewModel.updateCursorScreenPosition(null)
                            },
                            modifier = Modifier.size(56.dp)
                        ) {
                            Icon(
                                imageVector = Icons.Default.LocationOn,
                                contentDescription = "ÎÇ¥ ÏúÑÏπòÎ°ú Ïù¥Îèô",
                                modifier = Modifier.size(24.dp)
                            )
                        }
                        }
                    }
                ) { innerPadding ->
                    ChartPlotterMap(
                        modifier = Modifier
                            .fillMaxSize()
                            .padding(innerPadding),
                        isDialogShown = dialogUiState.showDialog || 
                                       dialogUiState.showPointManageDialog || 
                                       dialogUiState.showEditDialog || 
                                       dialogUiState.showPointDeleteList || 
                                       dialogUiState.showPointSelectionDialog || 
                                       dialogUiState.showWaypointDialog || 
                                       dialogUiState.showTrackSettingsDialog || 
                                       dialogUiState.showTrackListDialog || 
                                       dialogUiState.showTrackRecordListDialog,
                        showCursor = mapUiState.showCursor,
                        cursorLatLng = mapUiState.cursorLatLng,
                        cursorScreenPosition = mapUiState.cursorScreenPosition,
                        onTouchEnd = { latLng, screenPoint ->
                            viewModel.updateCursorLatLng(latLng)
                            viewModel.updateCursorScreenPosition(screenPoint)
                            viewModel.updateShowCursor(true)
                        },
                        onTouchStart = {
                            // ÎìúÎûòÍ∑∏ ÏãúÏûë Ïãú Ïª§ÏÑú ÌëúÏãú
                            viewModel.updateShowCursor(true)
                        },
                        onMapReady = { map ->

                            map.uiSettings.apply {
                                isCompassEnabled = false  // ÎÇòÏπ®Î∞ò ÏôÑÏ†ÑÌûà Ïà®ÍπÄ
                            }
                            /* ‚úÖ Ï§å Ï†úÌïú */
                            map.setMinZoomPreference(6.0)     // ÏµúÏÜå z=4
                            map.setMaxZoomPreference(22.0)    // (ÏõêÌïòÏãúÎ©¥ Îçî ÌÇ§Ïö∞Í±∞ÎÇò Ï§ÑÏù¥Í∏∞)

                            /* ‚úÖ ÌÑ∞Ïπò Í¥ÄÎ†® UI ÏÑ§Ï†ï - ÏßÄÎèÑ Ïù¥Îèô ÌóàÏö©, ÌöåÏ†ÑÎßå ÎπÑÌôúÏÑ±Ìôî */
                            map.uiSettings.isScrollGesturesEnabled = true
                            map.uiSettings.isZoomGesturesEnabled = true
                            map.uiSettings.isTiltGesturesEnabled = false
                            map.uiSettings.isDoubleTapGesturesEnabled = true
                            map.uiSettings.isQuickZoomGesturesEnabled = true
                            map.uiSettings.isRotateGesturesEnabled = false

                            /* ‚úÖ AttributionÍ≥º Logo Ïà®Í∏∞Í∏∞ - ÏßÄÎèÑ Ïù¥Îèô ÌõÑ ÎÇòÌÉÄÎÇòÎäî Ïõê Ï†úÍ±∞ */
                            map.uiSettings.isAttributionEnabled = false
                            map.uiSettings.isLogoEnabled = false

                            map.uiSettings.isFlingVelocityAnimationEnabled = false

                            // Î™©Ï†ÅÏßÄ ÎßàÏª§ Ï∂îÍ∞Ä (ÏßÄÎèÑ Ïä§ÌÉÄÏùº Î°úÎìú ÏôÑÎ£å ÌõÑ)
                            map.getStyle { style ->
                                // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ÏùÑ ÎëêÍ≥† ÎßàÏª§ Ï∂îÍ∞Ä (Ïä§ÌÉÄÏùº ÏôÑÏ†Ñ Î°úÎìú ÎåÄÍ∏∞)
                                android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
                                    // Î™©Ï†ÅÏßÄ ÎßàÏª§Îäî Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå
                                    
                                    // Ìï≠Ï†Å ÌëúÏãú
                                    // ViewModelÏùÄ setContent Î∏îÎ°ùÏóêÏÑú ÏÉùÏÑ±ÎêòÎØÄÎ°ú Ïó¨Í∏∞ÏÑúÎäî ÏßÅÏ†ë Ï†ëÍ∑º Î∂àÍ∞Ä
                                    // Ïù¥ Î∂ÄÎ∂ÑÏùÄ ÎÇòÏ§ëÏóê ÏàòÏ†ï ÌïÑÏöî
                                }, 500) // 0.5Ï¥à ÏßÄÏó∞
                            }

                            /* ‚úÖ Ïπ¥Î©îÎùº ÌÉÄÍ≤ü Î≤îÏúÑ Ï†úÌïú: Ìïú¬∑Ï§ë¬∑Ïùº ÎåÄÎûµ Ïª§Î≤Ñ */
                            val regionBounds = LatLngBounds.Builder()
                                // NE, SW 2Ï†êÎßåÏúºÎ°ú Î≤îÏúÑ Íµ¨ÏÑ±
                                .include(LatLng(42.0, 150.0))  // Î∂ÅÎèô (ÎåÄÎûµ ÏùºÎ≥∏ Î∂ÅÎ∂Ä~Ïø†Î¶¥ Ïó¥ÎèÑ Î∂ÄÍ∑ºÍπåÏßÄ)
                                .include(LatLng(24.0, 120.0))   // ÎÇ®ÏÑú (Ï§ëÍµ≠ ÎÇ®Î∂Ä~Î≤†Ìä∏ÎÇ® Î∂ÅÎ∂Ä ÏúÑÎèÑÍπåÏßÄ)
                                .build()

                            map.setLatLngBoundsForCameraTarget(regionBounds)
                            if (!mapUiState.isMapInitialized) {
                                mapLibreMap = map
                                viewModel.updateIsMapInitialized(true)
                                locationManager = LocationManager(
                                    this@MainActivity,
                                    map,
                                    onGpsLocationUpdate = { lat, lng, available ->
                                        viewModel.updateGpsLocation(lat, lng, available)

                                        // Ìï≠Ï†Å Í∏∞Î°ù Ï†ê Ï∂îÍ∞Ä
                                        addTrackPointIfNeeded(lat, lng, viewModel)

                                        // Í≤ΩÏú†ÏßÄ ÏûêÎèô Ï†úÍ±∞: ÌòÑÏû¨ ÏúÑÏπòÏóêÏÑú 10m Ïù¥ÎÇ¥Ïù∏ Í≤ΩÏú†ÏßÄ Ï†úÍ±∞
                                        val waypointsToRemove = mutableListOf<SavedPoint>()
                                        mapUiState.waypoints.forEach { waypoint ->
                                            val distance = calculateDistance(
                                                lat, lng,
                                                waypoint.latitude, waypoint.longitude
                                            )
                                            if (distance <= 10.0) { // 10m Ïù¥ÎÇ¥
                                                waypointsToRemove.add(waypoint)
                                                Log.d("[MainActivity]", "Í≤ΩÏú†ÏßÄ ÎèÑÎã¨: ${waypoint.name} (Í±∞Î¶¨: ${String.format("%.2f", distance)}m)")
                                            }
                                        }
                                        
                                        // ÎèÑÎã¨Ìïú Í≤ΩÏú†ÏßÄ Ï†úÍ±∞
                                        if (waypointsToRemove.isNotEmpty()) {
                                            val updatedWaypoints = mapUiState.waypoints.toMutableList()
                                            updatedWaypoints.removeAll(waypointsToRemove)
                                            viewModel.updateWaypoints(updatedWaypoints)
                                            Log.d("[MainActivity]", "Í≤ΩÏú†ÏßÄ ${waypointsToRemove.size}Í∞ú Ï†úÍ±∞Îê®")
                                        }

                                        // Ìï≠Ìï¥ Í≤ΩÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ (Î™®Îì† Î™®ÎìúÏóêÏÑú navigationPointÍ∞Ä ÏûàÏúºÎ©¥)
                                        if (mapUiState.navigationPoint != null) {
                                            val currentLocation = locationManager?.getCurrentLocationObject()
                                            if (currentLocation != null) {
                                                val currentLatLng = LatLng(currentLocation.latitude, currentLocation.longitude)
                                                val waypointLatLngs = mapUiState.waypoints.map { LatLng(it.latitude, it.longitude) }
                                                val navigationLatLng = LatLng(mapUiState.navigationPoint!!.latitude, mapUiState.navigationPoint!!.longitude)
                                                PMTilesLoader.addNavigationRoute(map, currentLatLng, waypointLatLngs, navigationLatLng)
                                            }
                                        }
                                    },
                                    onBearingUpdate = { bearing ->
                                        // COG Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                                        viewModel.updateCog(bearing)
                                        // Ìó§Îî©ÏóÖ Î™®ÎìúÏùº ÎïåÎßå ÏßÄÎèÑ ÌöåÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏
                                        if (mapUiState.mapDisplayMode == "Ìó§Îî©ÏóÖ") {
//                                            Log.d("[MainActivity]", "Ìó§Îî©ÏóÖ Î™®Îìú: Î≥¥Ìä∏ Î∞©Ìñ• ${bearing}ÎèÑÎ°ú ÏßÄÎèÑ ÌöåÏ†Ñ")
                                            updateMapRotation(viewModel)
                                        } else {
//                                            Log.v("[MainActivity]", "Î≥¥Ìä∏ Î∞©Ìñ• ${bearing}ÎèÑ Í∞êÏßÄÎê® (ÌòÑÏû¨ Î™®Îìú: ${mapUiState.mapDisplayMode})")
                                        }
                                    }
                                )

                                // ÏÑºÏÑú Ï¥àÍ∏∞Ìôî
                                locationManager?.initializeSensors()
                                
                                // GPSÏôÄ Î∞©Ìñ• Ï†ïÎ≥¥ Ï†úÍ≥µ Ïó¨Î∂Ä ÌôïÏù∏
                                locationManager?.checkAvailability()?.let { status ->
                                    Log.d("[MainActivity]", "=== GPS Î∞è Î∞©Ìñ• Ï†ïÎ≥¥ ÏÉÅÌÉú ===")
                                    Log.d("[MainActivity]", "GPS Ï†úÍ≥µ Í∞ÄÎä•: ${status.gpsAvailable}")
                                    Log.d("[MainActivity]", "  - ÏúÑÏπò Í∂åÌïú: ${status.locationPermissionGranted}")
                                    Log.d("[MainActivity]", "  - GPS ÌîÑÎ°úÎ∞îÏù¥Îçî: ${status.gpsEnabled}")
                                    Log.d("[MainActivity]", "  - ÎÑ§Ìä∏ÏõåÌÅ¨ ÏúÑÏπò: ${status.networkLocationEnabled}")
                                    Log.d("[MainActivity]", "Î∞©Ìñ• Ï†ïÎ≥¥ Ï†úÍ≥µ Í∞ÄÎä•: ${status.bearingAvailable}")
                                    Log.d("[MainActivity]", "  - Î∞©Ìñ• ÏÑºÏÑú: ${status.orientationSensorAvailable}")
                                    Log.d("[MainActivity]", "  - ÌöåÏ†Ñ Î≤°ÌÑ∞ ÏÑºÏÑú: ${status.rotationVectorSensorAvailable}")
                                    Log.d("[MainActivity]", "================================")
                                }

                                // PMTiles Î°úÎìú ÌõÑ ÏÑ†Î∞ï ÏïÑÏù¥ÏΩòÍ≥º Ìè¨Ïù∏Ìä∏ ÎßàÏª§ Ï∂îÍ∞ÄÎ•º ÏúÑÌï¥ Ïä§ÌÉÄÏùº Î°úÎìú ÏôÑÎ£åÎ•º Í∏∞Îã§Î¶º
                                map.getStyle { style ->
                                    locationManager?.addShipToMap(style)
                                    locationManager?.addPointsToMap(style)

                                    // Ï†ÄÏû•Îêú Ìè¨Ïù∏Ìä∏Îì§ÏùÑ ÏßÄÎèÑÏóê ÌëúÏãú
                                    val savedPoints = loadPointsFromLocal()
                                    locationManager?.updatePointsOnMap(savedPoints)
                                }

                                // ÏßÄÎèÑ ÌÑ∞Ïπò/ÎìúÎûòÍ∑∏ Í∞êÏßÄÌïòÏó¨ ÏûêÎèô Ï∂îÏ†Å Ï§ëÏßÄ (ÏàòÎèô ÌöåÏ†ÑÏùÄ ÎπÑÌôúÏÑ±Ìôî)
                                map.addOnCameraMoveListener {
                                    locationManager?.stopAutoTracking()
                                    // ÏàòÎèô ÌöåÏ†ÑÏùÄ ÎπÑÌôúÏÑ±Ìôî - ÏßÄÎèÑ ÌëúÏãú Î™®ÎìúÏóê Îî∞Îùº ÏûêÎèô ÌöåÏ†ÑÎßå ÌóàÏö©
                                }
                                
                                // Ïπ¥Î©îÎùº Ïù¥ÎèôÏù¥ ÏôÑÏ†ÑÌûà ÎÅùÎÇú ÌõÑ Ïª§ÏÑú GPS Ï¢åÌëú ÏóÖÎç∞Ïù¥Ìä∏ (Ï§å Ïù∏/ÏïÑÏõÉ Ïãú ÌùîÎì§Î¶º Î∞©ÏßÄ)
                                map.addOnCameraIdleListener {
                                    // Ïª§ÏÑúÍ∞Ä ÌëúÏãúÎêòÍ≥† ÏûàÏùÑ Îïå, Îßµ Ïù¥Îèô ÏôÑÎ£å ÌõÑ Ïª§ÏÑúÏùò GPS Ï¢åÌëú ÏóÖÎç∞Ïù¥Ìä∏
                                    if (mapUiState.showCursor && mapUiState.cursorScreenPosition != null) {
                                        val screenPoint = mapUiState.cursorScreenPosition!!
                                        try {
                                            val updatedLatLng = map.projection.fromScreenLocation(
                                                android.graphics.PointF(screenPoint.x, screenPoint.y)
                                            )
                                            viewModel.updateCursorLatLng(updatedLatLng)
                                            Log.d("[MainActivity]", "Îßµ Ïù¥Îèô ÏôÑÎ£å ÌõÑ Ïª§ÏÑú GPS Ï¢åÌëú ÏóÖÎç∞Ïù¥Ìä∏: ${updatedLatLng.latitude}, ${updatedLatLng.longitude}")
                                        } catch (e: Exception) {
                                            Log.e("[MainActivity]", "Ïª§ÏÑú GPS Ï¢åÌëú ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ${e.message}")
                                        }
                                    }
                                }

                                // ÏßÄÎèÑ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨ (Ìè¨Ïù∏Ìä∏ ÎßàÏª§ ÌÅ¥Î¶≠ Í∞êÏßÄ + ÌÑ∞Ïπò ÏúÑÏπòÏóê Ïª§ÏÑú ÌëúÏãú)
                                map.addOnMapClickListener { latLng ->
                                    // Í≤ΩÏú†ÏßÄ Ï∂îÍ∞Ä Î™®ÎìúÏù∏ Í≤ΩÏö∞: Ïª§ÏÑúÎßå ÌëúÏãú
                                    if (dialogUiState.isAddingWaypoint) {
                                        val screenPoint = map.projection.toScreenLocation(latLng)
                                        viewModel.updateCursorLatLng(latLng)
                                        viewModel.updateCursorScreenPosition(screenPoint)
                                        viewModel.updateShowCursor(true)
                                        Log.d("[MainActivity]", "Í≤ΩÏú†ÏßÄ Ï∂îÍ∞Ä Î™®Îìú: Ïª§ÏÑú ÏúÑÏπò ÏÑ§Ï†ï ${latLng.latitude}, ${latLng.longitude}")
                                        true // Í∏∞Î≥∏ ÏßÄÎèÑ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î∞©ÏßÄ
                                    } else {
                                        // Í∏∞Ï°¥ Î°úÏßÅ: Ìè¨Ïù∏Ìä∏ ÌÅ¥Î¶≠ Í∞êÏßÄ Î∞è Ïª§ÏÑú ÌëúÏãú
                                        // ÌÅ¥Î¶≠Îêú ÏúÑÏπòÏóêÏÑú Ìè¨Ïù∏Ìä∏ Î†àÏù¥Ïñ¥Ïùò ÌîºÏ≤òÎì§ÏùÑ ÏøºÎ¶¨
                                        val screenPoint = map.projection.toScreenLocation(latLng)
                                        val features = map.queryRenderedFeatures(
                                            android.graphics.PointF(screenPoint.x, screenPoint.y),
                                            "points-symbol"
                                        )

                                        // Ìï≠ÏÉÅ ÌÑ∞ÏπòÌïú ÏúÑÏπòÏóê Ïª§ÏÑú ÌëúÏãú
                                        viewModel.updateCursorLatLng(latLng)
                                        viewModel.updateCursorScreenPosition(screenPoint)
                                        viewModel.updateShowCursor(true)

                                        if (features.isNotEmpty()) {
                                            // Ìè¨Ïù∏Ìä∏Í∞Ä ÌÅ¥Î¶≠ÎêòÏóàÏùå
                                            val feature = features.first()
                                            val pointName = feature.getStringProperty("name") ?: ""
                                            val pointId = feature.getStringProperty("id") ?: ""

                                            // Ï†ÄÏû•Îêú Ìè¨Ïù∏Ìä∏ Î™©Î°ùÏóêÏÑú Ìï¥Îãπ Ìè¨Ïù∏Ìä∏ Ï∞æÍ∏∞
                                            val savedPoints = loadPointsFromLocal()
                                            val clickedPoint = savedPoints.find { point ->
                                                "${point.latitude}_${point.longitude}_${point.timestamp}" == pointId
                                            }

                                            clickedPoint?.let { point ->
                                                viewModel.updateSelectedPoint(point)
                                                viewModel.updateEditPointName(point.name)
                                                viewModel.updateEditSelectedColor(point.color)
                                                viewModel.updateShowPointManageDialog(true)
                                            }

                                            Log.d("[MainActivity]", "Ìè¨Ïù∏Ìä∏ ÌÅ¥Î¶≠ + Ïª§ÏÑú ÌëúÏãú: ${latLng.latitude}, ${latLng.longitude}")

                                            true // Í∏∞Î≥∏ ÏßÄÎèÑ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î∞©ÏßÄ
                                        } else {
                                            Log.d("[MainActivity]", "ÌÑ∞Ïπò ÏúÑÏπòÏóê Ïª§ÏÑú ÌëúÏãú: ${latLng.latitude}, ${latLng.longitude}")

                                            false // Í∏∞Î≥∏ ÏßÄÎèÑ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÌóàÏö©
                                        }
                                    }
                                }


                                // ÏúÑÏπò Í∂åÌïú ÌôïÏù∏ Î∞è ÏöîÏ≤≠
                                if (ContextCompat.checkSelfPermission(
                                        this@MainActivity,
                                        Manifest.permission.ACCESS_FINE_LOCATION
                                    ) == PackageManager.PERMISSION_GRANTED
                                ) {
                                    locationManager?.startLocationUpdates()
                                    // Ï≤´ Î≤àÏß∏ ÏúÑÏπò Ï†ïÎ≥¥Î•º Î∞õÏúºÎ©¥ ÏûêÎèôÏúºÎ°ú Í∑∏ ÏúÑÏπòÎ°ú Ïù¥Îèô (onLocationChangedÏóêÏÑú Ï≤òÎ¶¨)
                                    Log.d("[MainActivity]", "ÏúÑÏπò Ï∂îÏ†Å ÏãúÏûë - Ï≤´ Î≤àÏß∏ ÏúÑÏπòÏóêÏÑú ÏûêÎèô Ïù¥Îèô")
                                } else {
                                    locationPermissionRequest.launch(
                                        arrayOf(
                                            Manifest.permission.ACCESS_FINE_LOCATION,
                                            Manifest.permission.ACCESS_COARSE_LOCATION
                                        )
                                    )
                                }

                            }
                        }
                    )

                    // Ïö∞Ï∏° ÏÉÅÎã® Î©îÎâ¥ Î≤ÑÌäº
                    Box(
                        modifier = Modifier
                            .fillMaxSize()
                            .statusBarsPadding()
                            .padding(top = 24.dp, end = 16.dp, start = 16.dp, bottom = 16.dp),
                        contentAlignment = Alignment.TopEnd
                    ) {
                        Row(
                            horizontalArrangement = Arrangement.spacedBy(8.dp)
                        ) {
                            // Ìè¨Ïù∏Ìä∏ ÏÉùÏÑ± Î≤ÑÌäº (Ïª§ÏÑúÍ∞Ä ÌëúÏãúÎê† ÎïåÎßå Î≥¥ÏûÑ)
                            if (mapUiState.showCursor) {
                                FloatingActionButton(
                                    onClick = { createQuickPoint(viewModel) },
                                    shape = RoundedCornerShape(16.dp),
                                    containerColor = Color(0xC6E0E0E0),
                                    contentColor = Color.Black,
                                    elevation = FloatingActionButtonDefaults.elevation(
                                        defaultElevation = 0.dp,
                                        pressedElevation = 0.dp,
                                        focusedElevation = 0.dp,
                                        hoveredElevation = 0.dp
                                    ),
                                    modifier = Modifier
                                        .size(48.dp)
                                        .border(
                                            width = 1.dp,
                                            color = Color.White ,
                                            shape = RoundedCornerShape(16.dp)
                                        ),
                                ) {
                                    Icon(
                                        imageVector = Icons.Filled.Flag,
                                        contentDescription = "Ìè¨Ïù∏Ìä∏ Ï∂îÍ∞Ä",
                                        modifier = Modifier.size(24.dp)
                                    )
                                }
                                
                                // Í≤ΩÏú†ÏßÄ ÌôïÏù∏ Î≤ÑÌäº (Í≤ΩÏú†ÏßÄ Ï∂îÍ∞Ä Î™®ÎìúÏù¥Í≥† Ïª§ÏÑúÍ∞Ä ÌëúÏãúÎê† ÎïåÎßå Î≥¥ÏûÑ)
                                if (dialogUiState.isAddingWaypoint && mapUiState.showCursor && mapUiState.cursorLatLng != null) {
                                    FloatingActionButton(
                                        onClick = { 
                                            // ÌòÑÏû¨ Ïª§ÏÑú ÏúÑÏπòÎ•º Í≤ΩÏú†ÏßÄÎ°ú Ï∂îÍ∞Ä
                                            mapUiState.cursorLatLng?.let { latLng ->
                                                val newWaypoint = SavedPoint(
                                                    name = "Í≤ΩÏú†ÏßÄ ${mapUiState.waypoints.size + 1}",
                                                    latitude = latLng.latitude,
                                                    longitude = latLng.longitude,
                                                    color = Color.Yellow, // Í≤ΩÏú†ÏßÄÎäî ÎÖ∏ÎûÄÏÉâÏúºÎ°ú ÌëúÏãú
                                                    iconType = "circle",
                                                    timestamp = System.currentTimeMillis()
                                                )
                                                val updatedWaypoints = mapUiState.waypoints.toMutableList()
                                                updatedWaypoints.add(newWaypoint)
                                                viewModel.updateWaypoints(updatedWaypoints)
                                                
                                                // Í≤ΩÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                                                if (mapUiState.navigationPoint != null) {
                                                    val currentLocation = locationManager?.getCurrentLocationObject()
                                                    val mapForRoute = mapLibreMap
                                                    if (currentLocation != null && mapForRoute != null) {
                                                        val currentLatLng = LatLng(currentLocation.latitude, currentLocation.longitude)
                                                        val waypointLatLngs = updatedWaypoints.map { LatLng(it.latitude, it.longitude) }
                                                        val navigationLatLng = LatLng(mapUiState.navigationPoint!!.latitude, mapUiState.navigationPoint!!.longitude)
                                                        PMTilesLoader.addNavigationRoute(mapForRoute, currentLatLng, waypointLatLngs, navigationLatLng)
                                                    }
                                                }
                                                
                                                // Ïª§ÏÑú Ïà®ÍπÄ Î∞è Í≤ΩÏú†ÏßÄ Ï∂îÍ∞Ä Î™®Îìú Ïú†ÏßÄ (Ïó¨Îü¨ Í≤ΩÏú†ÏßÄ Ï∂îÍ∞Ä Í∞ÄÎä•)
                                                viewModel.updateShowCursor(false)
                                                viewModel.updateCursorLatLng(null)
                                                viewModel.updateCursorScreenPosition(null)
                                                
                                                Log.d("[MainActivity]", "Í≤ΩÏú†ÏßÄ Ï∂îÍ∞ÄÎê®: ${latLng.latitude}, ${latLng.longitude}")
                                            }
                                        },
                                        shape = RoundedCornerShape(16.dp),
                                        containerColor = Color(0xC6FFA500), // Ï£ºÌô©ÏÉâ
                                        contentColor = Color.White,
                                        elevation = FloatingActionButtonDefaults.elevation(
                                            defaultElevation = 0.dp,
                                            pressedElevation = 0.dp,
                                            focusedElevation = 0.dp,
                                            hoveredElevation = 0.dp
                                        ),
                                        modifier = Modifier
                                            .size(48.dp)
                                            .border(
                                                width = 1.dp,
                                                color = Color.White,
                                                shape = RoundedCornerShape(16.dp)
                                            ),
                                    ) {
                                        Icon(
                                            imageVector = Icons.Filled.Check,
                                            contentDescription = "Í≤ΩÏú†ÏßÄ ÌôïÏù∏",
                                            modifier = Modifier.size(24.dp)
                                        )
                                    }
                                }
                                
                                // Ìï≠Ìï¥ Î≤ÑÌäº (Ïª§ÏÑúÍ∞Ä ÌëúÏãúÎê† ÎïåÎßå Î≥¥ÏûÑ, Í≤ΩÏú†ÏßÄ Ï∂îÍ∞Ä Î™®ÎìúÍ∞Ä ÏïÑÎãê Îïå)
                                if (mapUiState.showCursor && !dialogUiState.isAddingWaypoint) {
                                    FloatingActionButton(
                                        onClick = { 
                                            // Ïª§ÏÑú ÏúÑÏπòÎ•º Ìï≠Ìï¥ Î™©Ï†ÅÏßÄÎ°ú ÏÑ§Ï†ï (ÏΩîÏä§ÏóÖ Î™®ÎìúÎ°ú Ï†ÑÌôòÌïòÏßÄ ÏïäÏùå)
                                            mapUiState.cursorLatLng?.let { latLng ->
                                                // Í∏∞Ï°¥ Ìï≠Ìï¥ ÏÑ†Í≥º ÎßàÏª§ Ï†úÍ±∞
                                                mapLibreMap?.let { map ->
                                                    PMTilesLoader.removeNavigationLine(map)
                                                    PMTilesLoader.removeNavigationMarker(map)
                                                }
                                                
                                                val newNavigationPoint = SavedPoint(
                                                    name = "Ïª§ÏÑú ÏúÑÏπò",
                                                    latitude = latLng.latitude,
                                                    longitude = latLng.longitude,
                                                    color = Color.Blue,
                                                    iconType = "circle",
                                                    timestamp = System.currentTimeMillis()
                                                )
                                                viewModel.updateNavigationPoint(newNavigationPoint)
                                                
                                                // Ï¶âÏãú Ìï≠Ìï¥ Í≤ΩÎ°ú ÌëúÏãú
                                                val currentLocation = locationManager?.getCurrentLocationObject()
                                                val map = mapLibreMap
                                                if (currentLocation != null && map != null) {
                                                    val currentLatLng = LatLng(currentLocation.latitude, currentLocation.longitude)
                                                    val waypointLatLngs = mapUiState.waypoints.map { LatLng(it.latitude, it.longitude) }
                                                    val navigationLatLng = LatLng(latLng.latitude, latLng.longitude)
                                                    PMTilesLoader.addNavigationRoute(map, currentLatLng, waypointLatLngs, navigationLatLng)
                                                }
                                                
                                                // Ïª§ÏÑú ÏúÑÏπòÏóê ÏûÑÏãú Ìè¨Ïù∏Ìä∏ ÎßàÏª§ ÌëúÏãú
                                                val mapForMarker = mapLibreMap
                                                if (mapForMarker != null) {
                                                    PMTilesLoader.addNavigationMarker(mapForMarker, latLng, "Ïª§ÏÑú ÏúÑÏπò")
                                                }
                                                
                                                // ÏΩîÏä§ÏóÖ Î™®ÎìúÍ∞Ä ÏºúÏ†∏ ÏûàÎã§Î©¥ ÏÉàÎ°úÏö¥ Ïª§ÏÑú ÏúÑÏπòÎ°ú ÏΩîÏä§ÏóÖ Ï†ÅÏö©
                                                if (mapUiState.mapDisplayMode == "ÏΩîÏä§ÏóÖ") {
                                                    viewModel.updateCoursePoint(newNavigationPoint)
                                                    updateMapRotation(viewModel)
                                                    
                                                    // Ïª§ÏÑúÎ•º Î™©Ï†ÅÏßÄ ÏúÑÏπòÎ°ú Ïù¥Îèô
                                                    viewModel.updateCursorLatLng(latLng)
                                                    val screenPoint = mapLibreMap?.projection?.toScreenLocation(latLng)
                                                    if (screenPoint != null) {
                                                        viewModel.updateCursorScreenPosition(screenPoint)
                                                    }
                                                    
                                                    Log.d("[MainActivity]", "Ïª§ÏÑú ÏúÑÏπò Î≥ÄÍ≤ΩÏúºÎ°ú ÏΩîÏä§ÏóÖ Ïû¨Ï†ÅÏö©: ${latLng.latitude}, ${latLng.longitude}")
                                                }
                                                
                                                Log.d("[MainActivity]", "Ïª§ÏÑú ÏúÑÏπòÎ•º Ìï≠Ìï¥ Î™©Ï†ÅÏßÄÎ°ú ÏÑ§Ï†ï: ${latLng.latitude}, ${latLng.longitude}")
                                            }
                                        },
                                        shape = RoundedCornerShape(16.dp),
                                        containerColor = Color(0xC6007ACC), // ÌååÎûÄÏÉâ
                                        contentColor = Color.White,
                                        elevation = FloatingActionButtonDefaults.elevation(
                                            defaultElevation = 0.dp,
                                            pressedElevation = 0.dp,
                                            focusedElevation = 0.dp,
                                            hoveredElevation = 0.dp
                                        ),
                                        modifier = Modifier
                                            .size(48.dp)
                                            .border(
                                                width = 1.dp,
                                                color = Color.White,
                                                shape = RoundedCornerShape(16.dp)
                                            ),
                                    ) {
                                        Text(
                                            text = "üß≠",
                                            fontSize = 20.sp
                                        )
                                    }
                                }
                            }
                            
                            // Î©îÎâ¥ Î≤ÑÌäº
                            FloatingActionButton(
                                onClick = { viewModel.updateShowMenu(!mapUiState.showMenu) },
                                shape = RoundedCornerShape(16.dp),
                                containerColor = Color(0xC6E2E2E2),
                                contentColor = Color.Black,
                                elevation = FloatingActionButtonDefaults.elevation(
                                    defaultElevation = 0.dp,                   // ‚úÖ ÎÇ¥Î∂ÄÍ∞Ä Î∞ùÏïÑ Î≥¥Ïù¥Îäî Ìö®Í≥º ÏµúÏÜåÌôî
                                    pressedElevation = 0.dp,
                                    focusedElevation = 0.dp,
                                    hoveredElevation = 0.dp
                                ),
                                modifier = Modifier
                                    .size(48.dp)
//                                    .clip(CircleShape)
                                    .border(
                                        width = 1.dp,
                                        color = Color.White,
                                        shape =  RoundedCornerShape(16.dp)
                                    ),
                            ) {
                                Icon(
                                    imageVector = Icons.Default.Menu,
                                    contentDescription = "Î©îÎâ¥"
                                )
                            }
                        }
                    }
                    
                    // ÏïÑÏù¥ÏΩò ÏÑ†ÌÉù UI (Ïª§ÏÑúÍ∞Ä ÌëúÏãúÎê† ÎïåÎßå Î≥¥ÏûÑ, ÏßÄÎèÑ Ï¢åÏ∏° ÏÉÅÎã®)
                    if (mapUiState.showCursor) {
                        Box(
                            modifier = Modifier
                                .fillMaxSize()
                                .statusBarsPadding()
                                .padding(top = 24.dp, end = 16.dp, start = 16.dp, bottom = 16.dp),
                            contentAlignment = Alignment.TopStart
                        ) {
                            Row(
                                horizontalArrangement = Arrangement.spacedBy(8.dp),
                                verticalAlignment = Alignment.CenterVertically
                            ) {
                                // Ïù¥Ï†Ñ ÏïÑÏù¥ÏΩò Î≤ÑÌäº (<)
                                FloatingActionButton(
                                    onClick = { 
                                        val newIconType = when (pointUiState.selectedIconType) {
                                            "circle" -> "square"
                                            "triangle" -> "circle"
                                            "square" -> "triangle"
                                            else -> "circle"
                                        }
                                        viewModel.updateSelectedIconType(newIconType)
                                    },
                                    shape = RoundedCornerShape(8.dp),
                                    containerColor = Color(0xC6E2E2E2),
                                    contentColor = Color.Black,
                                    elevation = FloatingActionButtonDefaults.elevation(
                                        defaultElevation = 0.dp,
                                        pressedElevation = 0.dp,
                                        focusedElevation = 0.dp,
                                        hoveredElevation = 0.dp
                                    ),
                                    modifier = Modifier
                                        .size(32.dp)
                                        .border(
                                            width = 1.dp,
                                            color = Color.White,
                                            shape = RoundedCornerShape(8.dp)
                                        ),
                                ) {
                                    Text(
                                        text = "<",
                                        fontSize = 16.sp,
                                        fontWeight = FontWeight.Bold
                                    )
                                }
                                
                                // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏïÑÏù¥ÏΩò ÌëúÏãú
                                Box(
                                    modifier = Modifier
                                        .size(40.dp),
                                    contentAlignment = Alignment.Center
                                ) {
                                    when (pointUiState.selectedIconType) {
                                        "circle" -> {
                                            Box(
                                                modifier = Modifier
                                                    .size(20.dp)
                                                    .background(Color.Black, CircleShape)
                                            )
                                        }
                                        "triangle" -> {
                                            Text(
                                                text = "‚ñ≤",
                                                fontSize = 16.sp,
                                                color = Color.Black
                                            )
                                        }
                                        "square" -> {
                                            Box(
                                                modifier = Modifier
                                                    .size(16.dp)
                                                    .background(Color.Black, RoundedCornerShape(2.dp))
                                            )
                                        }
                                    }
                                }
                                
                                // Îã§Ïùå ÏïÑÏù¥ÏΩò Î≤ÑÌäº (>)
                                FloatingActionButton(
                                    onClick = { 
                                        val newIconType = when (pointUiState.selectedIconType) {
                                            "circle" -> "triangle"
                                            "triangle" -> "square"
                                            "square" -> "circle"
                                            else -> "circle"
                                        }
                                        viewModel.updateSelectedIconType(newIconType)
                                    },
                                    shape = RoundedCornerShape(8.dp),
                                    containerColor = Color(0xC6E2E2E2),
                                    contentColor = Color.Black,
                                    elevation = FloatingActionButtonDefaults.elevation(
                                        defaultElevation = 0.dp,
                                        pressedElevation = 0.dp,
                                        focusedElevation = 0.dp,
                                        hoveredElevation = 0.dp
                                    ),
                                    modifier = Modifier
                                        .size(32.dp)
                                        .border(
                                            width = 1.dp,
                                            color = Color.White,
                                            shape = RoundedCornerShape(8.dp)
                                        ),
                                ) {
                                    Text(
                                        text = ">",
                                        fontSize = 16.sp,
                                        fontWeight = FontWeight.Bold
                                    )
                                }
                            }
                        }
                    }
                    
                    // Î©îÎâ¥Î∞î (Ïö∞Ï∏°Ïóê Í≥†Ï†ï, ÏßÄÎèÑ Ï°∞Ïûë Î∞©Ìï¥ÌïòÏßÄ ÏïäÏùå)
                    if (mapUiState.showMenu) {
                        Box(
                            modifier = Modifier
                                .fillMaxSize()
                                .statusBarsPadding()
                                .padding(16.dp),
                            contentAlignment = Alignment.CenterEnd
                        ) {
                            Box(
                                modifier = Modifier
                                    .width(250.dp)
                                    .fillMaxHeight()
                                    .background(Color.DarkGray)
                                    .padding(16.dp)
                                    .pointerInput(Unit) {
                                        detectTapGestures { /* Î©îÎâ¥Ï∞Ω ÎÇ¥Î∂Ä ÌÅ¥Î¶≠ Ïãú ÏßÄÎèÑ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∞®Îã® */ }
                                    }
                            ) {
                                Column {
                                    // Î©îÎâ¥ Ìó§Îçî (Ï†úÎ™© + Îã´Í∏∞/Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäº)
                                    Row(
                                        modifier = Modifier.fillMaxWidth(),
                                        horizontalArrangement = Arrangement.SpaceBetween,
                                        verticalAlignment = Alignment.CenterVertically
                                    ) {
                                        Text(
                                            text = when (mapUiState.currentMenu) {
                                                "main" -> "Î©îÎâ¥"
                                                "point" -> "Ìè¨Ïù∏Ìä∏"
                                                "ais" -> "AIS"
                                                else -> "Î©îÎâ¥"
                                            },
                                            fontSize = 20.sp,
                                            fontWeight = FontWeight.Bold,
                                            color = Color.White
                                        )
                                        IconButton(
                                            onClick = { 
                                                if (mapUiState.currentMenu == "main") {
                                                    viewModel.updateShowMenu(false)
                                                    viewModel.updateCurrentMenu("main") // Î©îÎâ¥ Îã´ÏùÑ Îïå Ï¥àÍ∏∞Ìôî
                                                } else {
                                                    viewModel.updateCurrentMenu("main")
                                                }
                                            }
                                        ) {
                                            Icon(
                                                imageVector = if (mapUiState.currentMenu == "main") Icons.Default.Close else Icons.Default.ArrowBack,
                                                contentDescription = if (mapUiState.currentMenu == "main") "Î©îÎâ¥ Îã´Í∏∞" else "Îí§Î°úÍ∞ÄÍ∏∞",
                                                tint = Color.White
                                            )
                                        }
                                    }
                                    Spacer(modifier = Modifier.height(16.dp))
                                    
                                    // Î©îÏù∏ Î©îÎâ¥
                                    if (mapUiState.currentMenu == "main") {
                                        Text(
                                            "Ìè¨Ïù∏Ìä∏", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateCurrentMenu("point")
                                                },
                                            color = Color.White
                                        )
                                        
                                        Text(
                                            "Ìï≠Ìï¥", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateCurrentMenu("navigation")
                                                },
                                            color = Color.White
                                        )
                                        
                                        Text(
                                            "Ìï≠Ï†Å", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateCurrentMenu("track")
                                                },
                                            color = Color.White
                                        )
                                        
                                        Text(
                                            "AIS", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateCurrentMenu("ais")
                                                },
                                            color = Color.White
                                        )
                                        
                                        Text(
                                            "ÌôîÎ©¥ÌëúÏãú Î∞©Î≤ïÏÑ§Ï†ï", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateCurrentMenu("display")
                                                },
                                            color = Color.White
                                        )
                                        
                                        
                                        Text(
                                            "ÏÑ§Ï†ï", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateShowMenu(false)
                                                    viewModel.updateCurrentMenu("main") // Î©îÎâ¥ Îã´ÏùÑ Îïå Ï¥àÍ∏∞Ìôî
                                                    // TODO: ÏÑ§Ï†ï ÌôîÎ©¥ Íµ¨ÌòÑ
                                                },
                                            color = Color.White
                                        )
                                        
                                        Text(
                                            "Ï†ïÎ≥¥", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateShowMenu(false)
                                                    viewModel.updateCurrentMenu("main") // Î©îÎâ¥ Îã´ÏùÑ Îïå Ï¥àÍ∏∞Ìôî
                                                    // TODO: Ï†ïÎ≥¥ ÌôîÎ©¥ Íµ¨ÌòÑ
                                                },
                                            color = Color.White
                                        )
                                    }
                                    
                                    // Ìï≠Ìï¥ Î©îÎâ¥
                                    if (mapUiState.currentMenu == "navigation") {
                                        Text(
                                            "Ìï≠Ìï¥ ÏãúÏûë", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    val savedPoints = loadPointsFromLocal()
                                                    if (savedPoints.isNotEmpty()) {
                                                        viewModel.updateShowPointSelectionDialog(true)
                                                    } else {
                                                        Log.d("[MainActivity]", "Ï†ÄÏû•Îêú Ìè¨Ïù∏Ìä∏Í∞Ä ÏóÜÏñ¥ÏÑú Ìï≠Ìï¥Î•º ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§.")
                                                    }
                                                },
                                            color = Color.White
                                        )
                                        
                                        Text(
                                            "Î™©Ï†ÅÏßÄ Î≥ÄÍ≤Ω", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    val savedPoints = loadPointsFromLocal()
                                                    if (savedPoints.isNotEmpty()) {
                                                        viewModel.updateShowPointSelectionDialog(true)
                                                    } else {
                                                        Log.d("[MainActivity]", "Ï†ÄÏû•Îêú Ìè¨Ïù∏Ìä∏Í∞Ä ÏóÜÏñ¥ÏÑú Î™©Ï†ÅÏßÄÎ•º Î≥ÄÍ≤ΩÌï† Ïàò ÏóÜÏäµÎãàÎã§.")
                                                    }
                                                },
                                            color = Color.White
                                        )
                                        
                                        Text(
                                            "Í≤ΩÏú†ÏßÄ Í¥ÄÎ¶¨", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateShowWaypointDialog(true)
                                                },
                                            color = Color.White
                                        )
                                        
                                        Text(
                                            "Ìï≠Ìï¥ Ï§ëÏßÄ", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateMapDisplayMode("ÎÖ∏Ïä§ÏóÖ")
                                                    viewModel.updateCoursePoint(null)
                                                    viewModel.updateNavigationPoint(null)
                                                    viewModel.updateWaypoints(emptyList()) // Í≤ΩÏú†ÏßÄ Ï¥àÍ∏∞Ìôî
                                                    // Ìï≠Ìï¥ ÏÑ† Î∞è ÎßàÏª§ Ï†úÍ±∞
                                                    mapLibreMap?.let { map ->
                                                        PMTilesLoader.removeNavigationLine(map)
                                                        PMTilesLoader.removeNavigationMarker(map)
                                                    }
                                                    viewModel.updateCurrentMenu("main")
                                                },
                                            color = Color.White
                                        )
                                        
                                        // ÌòÑÏû¨ Ìï≠Ìï¥ ÏÉÅÌÉú ÌëúÏãú
                                        if (mapUiState.mapDisplayMode == "ÏΩîÏä§ÏóÖ" && (mapUiState.coursePoint != null || mapUiState.navigationPoint != null)) {
                                            Text(
                                                text = "Ìï≠Ìï¥ Ï§ë: ${mapUiState.coursePoint?.name ?: mapUiState.navigationPoint?.name ?: "Ïª§ÏÑú ÏúÑÏπò"}",
                                                fontSize = 14.sp,
                                                color = Color.Yellow,
                                                modifier = Modifier.padding(vertical = 8.dp)
                                            )
                                        }
                                    }
                                    
                                    // Ìï≠Ï†Å Î©îÎâ¥
                                    if (mapUiState.currentMenu == "track") {
                                        Text(
                                            "Ìï≠Ï†Å ÏÑ§Ï†ï", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateShowTrackSettingsDialog(true)
                                                    viewModel.updateShowMenu(false)
                                                    viewModel.updateCurrentMenu("main")
                                                },
                                            color = Color.White
                                        )
                                        
                                        Text(
                                            "Ìï≠Ï†Å Î™©Î°ù", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateShowTrackListDialog(true)
                                                    viewModel.updateShowMenu(false)
                                                    viewModel.updateCurrentMenu("main")
                                                },
                                            color = Color.White
                                        )
                                        
                                        // ÌòÑÏû¨ Í∏∞Î°ù Ï§ëÏù∏ Ìï≠Ï†ÅÏù¥ ÏûàÏúºÎ©¥ Ï§ëÏßÄ Î≤ÑÌäº ÌëúÏãú
                                        if (trackUiState.isRecordingTrack && trackUiState.currentRecordingTrack != null) {
                                            Text(
                                                "Ìï≠Ï†Å Í∏∞Î°ù Ï§ëÏßÄ", 
                                                modifier = Modifier
                                                    .fillMaxWidth()
                                                    .padding(vertical = 8.dp)
                                                    .clickable { 
                                                        stopTrackRecording(viewModel)
                                                        viewModel.updateShowMenu(false)
                                                        viewModel.updateCurrentMenu("main")
                                                    },
                                                color = Color.Red
                                            )
                                            
                                            Text(
                                                text = "Í∏∞Î°ù Ï§ë: ${trackUiState.currentRecordingTrack!!.name}",
                                                fontSize = 14.sp,
                                                color = Color.Yellow,
                                                modifier = Modifier.padding(vertical = 8.dp)
                                            )
                                        }
                                    }
                                    
                                    // Ìè¨Ïù∏Ìä∏ Î©îÎâ¥
                                    if (mapUiState.currentMenu == "point") {
                                        Text(
                                            "Ìè¨Ïù∏Ìä∏ ÏÉùÏÑ±", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    // Ïª§ÏÑú ÏúÑÏπòÍ∞Ä ÏûàÏúºÎ©¥ Ïª§ÏÑú ÏúÑÏπò ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ ÌôîÎ©¥ Ï§ëÏïô Ï¢åÌëú ÏÇ¨Ïö©
                                                    val targetLatLng = if (mapUiState.showCursor && mapUiState.cursorLatLng != null) {
                                                        mapUiState.cursorLatLng
                                                    } else {
                                                        mapLibreMap?.cameraPosition?.target
                                                    }
                                                    
                                                    targetLatLng?.let { latLng ->
                                                        viewModel.updateCurrentLatLng(latLng)
                                                        viewModel.updateCenterCoordinates("ÏúÑÎèÑ: ${String.format("%.6f", latLng.latitude)}\nÍ≤ΩÎèÑ: ${String.format("%.6f", latLng.longitude)}")
                                                        viewModel.updatePointName("Point${getNextAvailablePointNumber()}") // ÏûêÎèô Ìè¨Ïù∏Ìä∏Î™Ö ÏÉùÏÑ±
                                                        viewModel.updateSelectedColor(Color.Red) // ÏÉâÏÉÅ Ï¥àÍ∏∞Ìôî
                                                    } ?: run {
                                                        viewModel.updateCenterCoordinates("Ï¢åÌëúÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.")
                                                        viewModel.updateCurrentLatLng(null)
                                                    }
                                                    viewModel.updateShowMenu(false)
                                                    viewModel.updateCurrentMenu("main") // Î©îÎâ¥ Îã´ÏùÑ Îïå Ï¥àÍ∏∞Ìôî
                                                    viewModel.updateShowDialog(true)
                                                },
                                            color = Color.White
                                        )
                                        
                                        Text(
                                            "Ìè¨Ïù∏Ìä∏ ÏÇ≠Ï†ú", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateShowMenu(false)
                                                    viewModel.updateCurrentMenu("main") // Î©îÎâ¥ Îã´ÏùÑ Îïå Ï¥àÍ∏∞Ìôî
                                                    viewModel.updateShowPointDeleteList(true)
                                                },
                                            color = Color.White
                                        )
                                        
                                        Text(
                                            "Ìè¨Ïù∏Ìä∏ Î≥ÄÍ≤Ω", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateShowMenu(false)
                                                    viewModel.updateCurrentMenu("main") // Î©îÎâ¥ Îã´ÏùÑ Îïå Ï¥àÍ∏∞Ìôî
                                                    // TODO: Ìè¨Ïù∏Ìä∏ Î≥ÄÍ≤Ω ÌôîÎ©¥ Íµ¨ÌòÑ
                                                },
                                            color = Color.White
                                        )
                                    }
                                    
                                    // AIS Î©îÎâ¥
                                    if (mapUiState.currentMenu == "ais") {
                                        Text(
                                            "AIS ON/OFF", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateShowMenu(false)
                                                    viewModel.updateCurrentMenu("main") // Î©îÎâ¥ Îã´ÏùÑ Îïå Ï¥àÍ∏∞Ìôî
                                                    // TODO: AIS ON/OFF Íµ¨ÌòÑ
                                                },
                                            color = Color.White
                                        )
                                        
                                        Text(
                                            "AIS ÏÑ§Ï†ï", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    viewModel.updateShowMenu(false)
                                                    viewModel.updateCurrentMenu("main") // Î©îÎâ¥ Îã´ÏùÑ Îïå Ï¥àÍ∏∞Ìôî
                                                    // TODO: AIS ÏÑ§Ï†ï ÌôîÎ©¥ Íµ¨ÌòÑ
                                                },
                                            color = Color.White
                                        )
                                    }
                                    
                                    // ÌôîÎ©¥ÌëúÏãú Î∞©Î≤ïÏÑ§Ï†ï Î©îÎâ¥
                                    if (mapUiState.currentMenu == "display") {
                                        Text(
                                            "ÎÖ∏Ïä§ÏóÖ", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    Log.d("[MainActivity]", "ÏßÄÎèÑ ÌëúÏãú Î™®Îìú Î≥ÄÍ≤Ω: ${mapUiState.mapDisplayMode} -> ÎÖ∏Ïä§ÏóÖ")
                                                    viewModel.updateMapDisplayMode("ÎÖ∏Ïä§ÏóÖ")
                                                    viewModel.updateShowMenu(false)
                                                    viewModel.updateCurrentMenu("main") // Î©îÎâ¥ Îã´ÏùÑ Îïå Ï¥àÍ∏∞Ìôî
                                                },
                                            color = if (mapUiState.mapDisplayMode == "ÎÖ∏Ïä§ÏóÖ") Color.Yellow else Color.White
                                        )
                                        
                                        Text(
                                            "Ìó§Îî©ÏóÖ", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    Log.d("[MainActivity]", "ÏßÄÎèÑ ÌëúÏãú Î™®Îìú Î≥ÄÍ≤Ω: ${mapUiState.mapDisplayMode} -> Ìó§Îî©ÏóÖ")
                                                    viewModel.updateMapDisplayMode("Ìó§Îî©ÏóÖ")
                                                    viewModel.updateShowMenu(false)
                                                    viewModel.updateCurrentMenu("main") // Î©îÎâ¥ Îã´ÏùÑ Îïå Ï¥àÍ∏∞Ìôî
                                                },
                                            color = if (mapUiState.mapDisplayMode == "Ìó§Îî©ÏóÖ") Color.Yellow else Color.White
                                        )
                                        
                                        Text(
                                            "ÏΩîÏä§ÏóÖ", 
                                            modifier = Modifier
                                                .fillMaxWidth()
                                                .padding(vertical = 8.dp)
                                                .clickable { 
                                                    Log.d("[MainActivity]", "ÏßÄÎèÑ ÌëúÏãú Î™®Îìú Î≥ÄÍ≤Ω: ${mapUiState.mapDisplayMode} -> ÏΩîÏä§ÏóÖ")
                                                    
                                                    // Ìï≠Ìï¥ Ìè¨Ïù∏Ìä∏Í∞Ä ÏûàÏúºÎ©¥ Í∑∏Í≤ÉÏùÑ ÏΩîÏä§ÏóÖÏúºÎ°ú ÏÇ¨Ïö©
                                                    if (mapUiState.navigationPoint != null) {
                                                    viewModel.updateCoursePoint(mapUiState.navigationPoint)
                                                    viewModel.updateMapDisplayMode("ÏΩîÏä§ÏóÖ")
                                                    updateMapRotation(viewModel)
                                                    Log.d("[MainActivity]", "Ìï≠Ìï¥ Ìè¨Ïù∏Ìä∏Î•º ÏΩîÏä§ÏóÖÏúºÎ°ú Ï†ÅÏö©: ${mapUiState.navigationPoint!!.name}")
                                                    } else {
                                                        // Ìï≠Ìï¥ Ìè¨Ïù∏Ìä∏Í∞Ä ÏóÜÏúºÎ©¥ Ìè¨Ïù∏Ìä∏ Î™©Î°ùÏóêÏÑú ÏÑ†ÌÉù
                                                        val savedPoints = loadPointsFromLocal()
                                                        if (savedPoints.isNotEmpty()) {
                                                            viewModel.updateShowPointSelectionDialog(true)
                                                        } else {
                                                            android.util.Log.d("[MainActivity]", "ÏΩîÏä§ÏóÖÏùÑ ÏúÑÌï¥ Ìè¨Ïù∏Ìä∏Î•º Î®ºÏ†Ä ÏÉùÏÑ±ÌïòÏÑ∏Ïöî")
                                                        }
                                                    }
                                                    viewModel.updateShowMenu(false)
                                                    viewModel.updateCurrentMenu("main") // Î©îÎâ¥ Îã´ÏùÑ Îïå Ï¥àÍ∏∞Ìôî
                                                },
                                            color = if (mapUiState.mapDisplayMode == "ÏΩîÏä§ÏóÖ") Color.Yellow else Color.White
                                        )
                                        
                                    }
                                    
                                }
                            }
                        }
                    }
                    
                    // Ï§å Ïù∏/ÏïÑÏõÉ Î≤ÑÌäº (Í∞ÄÏö¥Îç∞ ÌïòÎã®)
                    Box(
                        modifier = Modifier
                            .fillMaxSize()
                            .navigationBarsPadding()
                            .padding(16.dp),
                        contentAlignment = Alignment.BottomCenter
                    ) {
                        Row(
                            horizontalArrangement = Arrangement.spacedBy(16.dp)
                        ) {
                            // Ï§å ÏïÑÏõÉ Î≤ÑÌäº
                            FloatingActionButton(
                                onClick = {

                                },
                                shape = RoundedCornerShape(16.dp),
                                containerColor = Color(0xC6E2E2E2),
                                contentColor = Color.Black,
                                elevation = FloatingActionButtonDefaults.elevation(
                                    defaultElevation = 0.dp,                   // ‚úÖ ÎÇ¥Î∂ÄÍ∞Ä Î∞ùÏïÑ Î≥¥Ïù¥Îäî Ìö®Í≥º ÏµúÏÜåÌôî
                                    pressedElevation = 0.dp,
                                    focusedElevation = 0.dp,
                                    hoveredElevation = 0.dp
                                ),
                                modifier = Modifier
                                    .size(56.dp)
//                                    .clip(CircleShape)
                                    .border(
                                        width = 1.dp,
                                        color = Color.White,
                                        shape =  RoundedCornerShape(16.dp)
                                    )

                                    ,
                            ) {
                                Box(
                                    Modifier
                                        .fillMaxSize()
//                                        .combinedClickable(
//                                            onClick = {
//                                                      },
//                                            onLongClick = {
//                                                isZoomInPressed = true
//                                            }
//                                        )
                                        .pointerInput(Unit) {
                                            detectTapGestures(
                                                onPress = {
                                                    // ÏÜêÍ∞ÄÎùΩÏù¥ ÎàåÎ¶¨Îäî ÏàúÍ∞Ñ
                                                    isZoomOutPressed = true
                                                    tryAwaitRelease() // ÏÜêÏùÑ ÎóÑ ÎïåÍπåÏßÄ ÎåÄÍ∏∞
                                                    // ÏÜêÏùÑ ÎñºÎ©¥ Ïó¨Í∏∞Î°ú ÎèåÏïÑÏò¥
                                                    isZoomOutPressed = false
                                                },
                                                onTap = {
                                                    // ÏßßÍ≤å ÎàåÎ†ÄÏùÑ Îïå ÎèôÏûë (ÏÑ†ÌÉùÏÇ¨Ìï≠)
                                                    mapLibreMap?.let { map ->
                                                        val currentZoom = map.cameraPosition.zoom
                                                        val newZoom = (currentZoom - 0.1).coerceAtLeast(0.0)

                                                        // Ïª§ÏÑúÍ∞Ä ÏûàÏúºÎ©¥ 3Îã®Í≥Ñ Ï≤òÎ¶¨


                                                        if (mapUiState.showCursor && mapUiState.cursorLatLng != null) {
                                                            // 1Îã®Í≥Ñ: Ïª§ÏÑúÎ•º Îßµ Ï§ëÏïôÏóê ÏúÑÏπò (ÌôîÎ©¥ Ï§ëÏïôÏúºÎ°ú Ïù¥Îèô)
                                                            val centerLatLng = map.cameraPosition.target
                                                            if (centerLatLng != null) {
                                                                val centerScreenPoint = map.projection.toScreenLocation(centerLatLng)
                                                                viewModel.updateCursorScreenPosition(centerScreenPoint)
                                                                Log.d("[MainActivity]", "Ï§å ÏïÑÏõÉ - 1Îã®Í≥Ñ: Ïª§ÏÑúÎ•º Îßµ Ï§ëÏïôÏóê ÏúÑÏπò")
                                                            }

                                                            // 2Îã®Í≥Ñ: Ïù¥ÎèôÌïòÍ∏∞ Ï†Ñ Ïª§ÏÑú ÏúÑÏπòÎ°ú ÏßÄÎèÑ Ï§ëÏïô ÎßûÏ∂§
                                                            val originalCursorLatLng = mapUiState.cursorLatLng!!
                                                            val cameraUpdate = org.maplibre.android.camera.CameraUpdateFactory.newCameraPosition(
                                                                org.maplibre.android.camera.CameraPosition.Builder()
                                                                    .target(originalCursorLatLng)
                                                                    .zoom(newZoom)
                                                                    .build()
                                                            )
                                                            map.animateCamera(cameraUpdate, 300)

                                                            Log.d("[MainActivity]", "Ï§å ÏïÑÏõÉ - 2Îã®Í≥Ñ: ÏõêÎûò Ïª§ÏÑú ÏúÑÏπòÎ°ú ÏßÄÎèÑ Ï§ëÏïô ÎßûÏ∂§ + 3Îã®Í≥Ñ: Ï§å ÏïÑÏõÉ Ï≤òÎ¶¨")
                                                        } else {
                                                            // Ïª§ÏÑúÍ∞Ä ÏóÜÏúºÎ©¥ ÏùºÎ∞ò Ï§å ÏïÑÏõÉ
                                                            val cameraUpdate = org.maplibre.android.camera.CameraUpdateFactory.zoomTo(newZoom)
                                                            map.animateCamera(cameraUpdate, 300)
                                                        }
                                                        Log.d("[MainActivity]", "Ï§å ÏïÑÏõÉ: $currentZoom -> $newZoom")
                                                    }
                                                    Log.d("[MainActivity]", "ÏßßÍ≤å ÌÅ¥Î¶≠")
                                                }
                                            )
                                        },

                                    contentAlignment = Alignment.Center
                                ) {
                                    Text(
                                        text = "-",
                                        fontSize = 20.sp,
                                        fontWeight = FontWeight.Bold
                                    )
                                }
                            }
                            
                            // Ï§å Ïù∏ Î≤ÑÌäº
                            FloatingActionButton(
                                onClick = {

                                },
                                shape = RoundedCornerShape(16.dp),
                                containerColor = Color(0xC6E2E2E2),
                                contentColor = Color.Black,
                                elevation = FloatingActionButtonDefaults.elevation(
                                    defaultElevation = 0.dp,                   // ‚úÖ ÎÇ¥Î∂ÄÍ∞Ä Î∞ùÏïÑ Î≥¥Ïù¥Îäî Ìö®Í≥º ÏµúÏÜåÌôî
                                    pressedElevation = 0.dp,
                                    focusedElevation = 0.dp,
                                    hoveredElevation = 0.dp
                                ),
                                modifier = Modifier
                                    .size(56.dp)
//                                    .clip(CircleShape)
                                    .border(
                                        width = 1.dp,
                                        color = Color.White,
                                        shape =  RoundedCornerShape(16.dp)
                                    )
                            ) {
                                Box(
                                    Modifier
                                        .fillMaxSize()
//                                        .combinedClickable(
//                                            onClick = {
//                                                      },
//                                            onLongClick = {
//                                                isZoomInPressed = true
//                                            }
//                                        )
                                        .pointerInput(Unit) {
                                            detectTapGestures(
                                                onPress = {
                                                    // ÏÜêÍ∞ÄÎùΩÏù¥ ÎàåÎ¶¨Îäî ÏàúÍ∞Ñ
                                                    isZoomInPressed = true
                                                    tryAwaitRelease() // ÏÜêÏùÑ ÎóÑ ÎïåÍπåÏßÄ ÎåÄÍ∏∞
                                                    // ÏÜêÏùÑ ÎñºÎ©¥ Ïó¨Í∏∞Î°ú ÎèåÏïÑÏò¥
                                                    isZoomInPressed = false
                                                },
                                                onTap = {
                                                    // ÏßßÍ≤å ÎàåÎ†ÄÏùÑ Îïå ÎèôÏûë (ÏÑ†ÌÉùÏÇ¨Ìï≠)
                                                    mapLibreMap?.let { map ->
                                                        val currentZoom = map.cameraPosition.zoom
                                                        val newZoom = (currentZoom + 0.1).coerceAtLeast(0.0)

                                                        // Ïª§ÏÑúÍ∞Ä ÏûàÏúºÎ©¥ 3Îã®Í≥Ñ Ï≤òÎ¶¨


                                                        if (mapUiState.showCursor && mapUiState.cursorLatLng != null) {
                                                            // 1Îã®Í≥Ñ: Ïª§ÏÑúÎ•º Îßµ Ï§ëÏïôÏóê ÏúÑÏπò (ÌôîÎ©¥ Ï§ëÏïôÏúºÎ°ú Ïù¥Îèô)
                                                            val centerLatLng = map.cameraPosition.target
                                                            if (centerLatLng != null) {
                                                                val centerScreenPoint = map.projection.toScreenLocation(centerLatLng)
                                                                viewModel.updateCursorScreenPosition(centerScreenPoint)
                                                                Log.d("[MainActivity]", "Ï§å ÏïÑÏõÉ - 1Îã®Í≥Ñ: Ïª§ÏÑúÎ•º Îßµ Ï§ëÏïôÏóê ÏúÑÏπò")
                                                            }

                                                            // 2Îã®Í≥Ñ: Ïù¥ÎèôÌïòÍ∏∞ Ï†Ñ Ïª§ÏÑú ÏúÑÏπòÎ°ú ÏßÄÎèÑ Ï§ëÏïô ÎßûÏ∂§
                                                            val originalCursorLatLng = mapUiState.cursorLatLng!!
                                                            val cameraUpdate = org.maplibre.android.camera.CameraUpdateFactory.newCameraPosition(
                                                                org.maplibre.android.camera.CameraPosition.Builder()
                                                                    .target(originalCursorLatLng)
                                                                    .zoom(newZoom)
                                                                    .build()
                                                            )
                                                            map.animateCamera(cameraUpdate, 300)

                                                            Log.d("[MainActivity]", "Ï§å ÏïÑÏõÉ - 2Îã®Í≥Ñ: ÏõêÎûò Ïª§ÏÑú ÏúÑÏπòÎ°ú ÏßÄÎèÑ Ï§ëÏïô ÎßûÏ∂§ + 3Îã®Í≥Ñ: Ï§å ÏïÑÏõÉ Ï≤òÎ¶¨")
                                                        } else {
                                                            // Ïª§ÏÑúÍ∞Ä ÏóÜÏúºÎ©¥ ÏùºÎ∞ò Ï§å ÏïÑÏõÉ
                                                            val cameraUpdate = org.maplibre.android.camera.CameraUpdateFactory.zoomTo(newZoom)
                                                            map.animateCamera(cameraUpdate, 300)
                                                        }
                                                        Log.d("[MainActivity]", "Ï§å ÏïÑÏõÉ: $currentZoom -> $newZoom")
                                                    }
                                                    Log.d("[MainActivity]", "ÏßßÍ≤å ÌÅ¥Î¶≠")
                                                }
                                            )
                                        },

                                    contentAlignment = Alignment.Center
                                ) {
                                    Text(
                                        text = "+",
                                        fontSize = 20.sp,
                                        fontWeight = FontWeight.Bold
                                    )
                                }
                            }
                        }
                    }
                    
                    // Í≤ΩÏú†ÏßÄ Ï∂îÍ∞Ä Î™®Îìú ÏïàÎÇ¥ Î©îÏãúÏßÄ
                    if (dialogUiState.isAddingWaypoint) {
                        Box(
                            modifier = Modifier
                                .fillMaxSize()
                                .statusBarsPadding()
                                .padding(top = 100.dp),
                            contentAlignment = Alignment.TopCenter
                        ) {
                            Box(
                                modifier = Modifier
                                    .background(Color.Black.copy(alpha = 0.7f), RoundedCornerShape(8.dp))
                                    .padding(16.dp)
                            ) {
                                Column(
                                    horizontalAlignment = Alignment.CenterHorizontally
                                ) {
                                    Text(
                                        text = "Í≤ΩÏú†ÏßÄ Ï∂îÍ∞Ä Î™®Îìú",
                                        color = Color.White,
                                        fontSize = 18.sp,
                                        fontWeight = FontWeight.Bold
                                    )
                                    Spacer(modifier = Modifier.height(8.dp))
                                    Text(
                                        text = "ÏßÄÎèÑÎ•º ÌÑ∞ÏπòÌïòÏó¨ Í≤ΩÏú†ÏßÄÎ•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî",
                                        color = Color.White,
                                        fontSize = 14.sp
                                    )
                                    Spacer(modifier = Modifier.height(8.dp))
                                    Row(
                                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                                    ) {
                                        OutlinedButton(
                                            onClick = {
                                                viewModel.updateIsAddingWaypoint(false)
                                                viewModel.updateShowCursor(false)
                                                viewModel.updateCursorLatLng(null)
                                                viewModel.updateCursorScreenPosition(null)
                                            }
                                        ) {
                                            Text("Ï∑®ÏÜå")
                                        }
                                        Button(
                                            onClick = {
                                                // ÌòÑÏû¨ Ïª§ÏÑú ÏúÑÏπòÍ∞Ä ÏûàÏúºÎ©¥ Í≤ΩÏú†ÏßÄÎ°ú Ï∂îÍ∞Ä
                                                mapUiState.cursorLatLng?.let { latLng ->
                                                    val newWaypoint = SavedPoint(
                                                        name = "Í≤ΩÏú†ÏßÄ ${mapUiState.waypoints.size + 1}",
                                                        latitude = latLng.latitude,
                                                        longitude = latLng.longitude,
                                                        color = Color.Yellow, // Í≤ΩÏú†ÏßÄÎäî ÎÖ∏ÎûÄÏÉâÏúºÎ°ú ÌëúÏãú
                                                        iconType = "circle",
                                                        timestamp = System.currentTimeMillis()
                                                    )
                                                    val updatedWaypoints = mapUiState.waypoints.toMutableList()
                                                    updatedWaypoints.add(newWaypoint)
                                                    viewModel.updateWaypoints(updatedWaypoints)
                                                    
                                                    // Í≤ΩÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                                                    if (mapUiState.navigationPoint != null) {
                                                        val currentLocation = locationManager?.getCurrentLocationObject()
                                                        val mapForRoute = mapLibreMap
                                                        if (currentLocation != null && mapForRoute != null) {
                                                            val currentLatLng = LatLng(currentLocation.latitude, currentLocation.longitude)
                                                            val waypointLatLngs = updatedWaypoints.map { LatLng(it.latitude, it.longitude) }
                                                            val navigationLatLng = LatLng(mapUiState.navigationPoint!!.latitude, mapUiState.navigationPoint!!.longitude)
                                                            PMTilesLoader.addNavigationRoute(mapForRoute, currentLatLng, waypointLatLngs, navigationLatLng)
                                                        }
                                                    }
                                                    
                                                    Log.d("[MainActivity]", "ÏôÑÎ£å Î≤ÑÌäºÏúºÎ°ú Í≤ΩÏú†ÏßÄ Ï∂îÍ∞ÄÎê®: ${latLng.latitude}, ${latLng.longitude}")
                                                }
                                                
                                                // Í≤ΩÏú†ÏßÄ Ï∂îÍ∞Ä Î™®Îìú Ï¢ÖÎ£å
                                                viewModel.updateIsAddingWaypoint(false)
                                                viewModel.updateShowCursor(false)
                                                viewModel.updateCursorLatLng(null)
                                                viewModel.updateCursorScreenPosition(null)
                                            }
                                        ) {
                                            Text("ÏôÑÎ£å")
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    // Ï¢åÏ∏° ÏÉÅÎã®: ÌòÑÏû¨ GPS, COG, ÌôîÎ©¥ÌëúÏãú Î™®Îìú (ÌÖçÏä§Ìä∏Îßå)
                    Box(
                        modifier = Modifier
                            .fillMaxSize()
                            .statusBarsPadding()
                            .padding(start = 16.dp, top = 66.dp),
                        contentAlignment = Alignment.TopStart
                    ) {
                        Column(
                            verticalArrangement = Arrangement.spacedBy(8.dp)
                        ) {
                            // GPS Ï¢åÌëú
                            if (gpsUiState.isAvailable) {
                                Column(
                                    verticalArrangement = Arrangement.spacedBy(2.dp)
                                ) {
                                    Text(
                                        text = "ÏúÑÎèÑ",
                                        color = Color.Black,
                                        fontSize = 12.sp
                                    )
                                    Text(
                                        text = String.format("%.6f", gpsUiState.latitude),
                                        color = Color.Black,
                                        fontSize = 18.sp,
                                        fontWeight = FontWeight.Bold
                                    )
                                }
                                
                                Column(
                                    verticalArrangement = Arrangement.spacedBy(2.dp)
                                ) {
                                    Text(
                                        text = "Í≤ΩÎèÑ",
                                        color = Color.Black,
                                        fontSize = 12.sp
                                    )
                                    Text(
                                        text = String.format("%.6f", gpsUiState.longitude),
                                        color = Color.Black,
                                        fontSize = 18.sp,
                                        fontWeight = FontWeight.Bold
                                    )
                                }
                            } else {
                                Text(
                                    text = "GPS Ïã†Ìò∏ ÏóÜÏùå",
                                    color = Color.Black,
                                    fontSize = 16.sp,
                                    fontWeight = FontWeight.Bold
                                )
                            }
                            
                            // COG
                            Column(
                                verticalArrangement = Arrangement.spacedBy(2.dp)
                            ) {
                                Text(
                                    text = "COG",
                                    color = Color.Black,
                                    fontSize = 12.sp
                                )
                                Text(
                                    text = "${String.format("%.1f", gpsUiState.cog)}¬∞",
                                    color = Color.Black,
                                    fontSize = 18.sp,
                                    fontWeight = FontWeight.Bold
                                )
                            }
                            
                            // ÌôîÎ©¥ÌëúÏãú Î™®Îìú
                            Column(
                                verticalArrangement = Arrangement.spacedBy(2.dp)
                            ) {
                                Text(
                                    text = "Î™®Îìú",
                                    color = Color.Black,
                                    fontSize = 12.sp
                                )
                                Text(
                                    text = mapUiState.mapDisplayMode,
                                    color = Color.Black,
                                    fontSize = 18.sp,
                                    fontWeight = FontWeight.Bold
                                )
                            }
                        }
                    }
                    
                    // Ï¢åÏ∏° ÌïòÎã®: Ïª§ÏÑú GPS Ï¢åÌëú (ÌöåÏÉâ ÏòÅÏó≠)
                    Box(
                        modifier = Modifier
                            .fillMaxSize()
                            .navigationBarsPadding()
                            .padding(16.dp),
                        contentAlignment = Alignment.BottomStart
                    ) {
                        if (mapUiState.showCursor && mapUiState.cursorLatLng != null) {
                            Box(
                                modifier = Modifier
                                    .background(
                                        Color.DarkGray.copy(alpha = 0.7f),
                                        RoundedCornerShape(8.dp)
                                    )
                                    .padding(12.dp)
                            ) {
                                Column {
                                    Text(
                                        text = "Ïª§ÏÑú GPS",
                                        color = Color.White,
                                        fontSize = 12.sp,
                                        fontWeight = FontWeight.Bold
                                    )
                                    Text(
                                        text = "ÏúÑÎèÑ: ${String.format("%.6f", mapUiState.cursorLatLng!!.latitude)}",
                                        color = Color.White,
                                        fontSize = 11.sp
                                    )
                                    Text(
